---
title:     "Trends from 30-year observations of downward solar irradiance in Thessaloniki, Greece"
author:
  - name:  Athanasios Natsis
    affil: 1 # \ddagger
    orcid: 0000-0002-5199-4119
  - name: Alkiviadis Bais
    affil: 1,* #, \dagger, # \ddagger
  - name: Charikleia Meleti
    affil: 1 #, \dagger, # \ddagger

affiliation:
  - num: 1
    address: |
      Aristotle University of Thessaloniki -
      Laboratory of Atmospheric Physics,
      Campus Box 149, 54124 Thessaloniki, Greece
    email: natsisphysicist@gmail.com (A.N.); abais@auth.gr (A.B.); meleti@auth.gr (C.M.)
  # - num: 2
  #   address: |
  #     Your department
  #     Street, City, Country
#     email: abais@auth.gr
# author citation list in chicago format
authorcitation: |
  Natsis, A.; Bais, A.; Meleti, C.
# firstnote to eighthnote
# firstnote: |
#   Current address: Updated affiliation
# secondnote: |
#   These authors contributed equally to this work.
correspondence: |
  abais@auth.gr
# natsisphysicist@gmail.com;
#   Tel.: +XX-000-00-0000.

# document options
journal: applsci
type:    article
status:  submit

# front matter
# simplesummary: |
#   A Simple summary goes here.

abstract: |
  The shortwave downward solar irradiance (SDR) is an important factor that drives climate processes, production and can affect all living organisms.
  Observations of SDR at different locations around the world with different environmental characteristics have been used to investigate its long-term variability and trends at different time scales.
  Periods of positive trends are referred as brightening periods and of negative trends as dimming periods.
  Here we studied 30 years of pyranometer data in Thessaloniki, Greece, under three types of sky conditions (clear sky, cloudy sky and all sky).
  The clear-sky data were identified by applying a cloud screening algorithm. We found a positive trend of $0.38\,\%/\text{year}$ for all-sky, $0.35\,\%/\text{year}$ for clear-sky conditions, and $-0.28\,\%/\text{year}$ for cloudy conditions.
  We have also investigated the consistency of these trends, their seasonal variability, and the effect of the solar zenith angle. 
  We have found that for all-sky and clear-sky conditions the SDR trend is positive in winter ($0.7$ and $0.8\,\%/\text{year}$, respectively) and autumn ($~0.4\,\%/\text{year}$), while under cloudy skies the trend is negative ($-0.9\,\%/\text{year}$ in winter and $-0.4\,\%/\text{year}$ in autumn). 
  In spring and summer the trend is very close to zero, irrespective of sky conditions. 
  The SDR trend is increasing with increasing solar zenith angle, except under cloudy skies where the trend is highly variable and close to zero.
  Finally, we identified some anomalies in the long term SDR trends for all sky conditions by examining the cumulative sums of monthly anomalies from the climatological mean.

# back matter
keywords: |
  GHI; SDR; solar radiation; Solar Brigthening/Dimming; aerosols; clouds.

# acknowledgement: |
#   All sources of funding of the study should be disclosed. Please clearly
#   indicate grants that you have received in support of your research work.
#   Clearly state if you received funds for covering the costs to publish in open
#   access.

# authorcontributions: |
#   For research articles with several authors, a short paragraph specifying their
#   individual contributions must be provided. The following statements should be
#   used ``X.X. and Y.Y. conceive and designed the experiments; X.X. performed the
#   experiments; X.X. and Y.Y. analyzed the data; W.W. contributed
#   reagents/materials/analysis tools; Y.Y. wrote the paper.'' Authorship must be
#   limited to those who have contributed substantially to the work reported.

funding: |
  This research received no external funding.

# funding: |
#   Please add: ``This research received no external funding'' or ``This research
#   was funded by NAME OF FUNDER grant number XXX.'' and  and ``The APC was funded
#   by XXX''. Check carefully that the details given are accurate and use the
#   standard spelling of funding agency names at
#   \url{https://search.crossref.org/funding}, any errors may affect your future
#   funding.

# institutionalreview: |
#   In this section, you should add the Institutional Review Board Statement and
#   approval number, if relevant to your study. You might choose to exclude
#   this statement if the study did not require ethical approval. Please note
#   that the Editorial Office might ask you for further information. Please add
#   “The study was conducted in accordance with the Declaration of Helsinki,
#   and approved by the Institutional Review Board (or Ethics Committee) of
#   NAME OF INSTITUTE (protocol code XXX and date of approval).” for studies
#   involving humans. OR “The animal study protocol was approved by the
#   Institutional Review Board (or Ethics Committee) of NAME OF INSTITUTE
#   (protocol code XXX and date of approval).” for studies involving animals.
#   OR “Ethical review and approval were waived for this study due to REASON
#   (please provide a detailed justification).” OR “Not applicable” for
#    studies not involving humans or animals.

# informedconsent: |
#   Any research article describing a study involving humans should contain this
#   statement. Please add ``Informed consent was obtained from all subjects
#   involved in the study.'' OR ``Patient consent was waived due to REASON
#   (please provide a detailed justification).'' OR ``Not applicable'' for
#   studies not involving humans. You might also choose to exclude this statement
#   if the study did not involve humans.
#
#   Written informed consent for publication must be obtained from participating
#   patients who can be identified (including by the patients themselves). Please
#   state ``Written informed consent has been obtained from the patient(s) to
#   publish this paper'' if applicable.

dataavailability: |
  Data as daily sums are available through the WRDC database \url{http://wrdc.mgo.rssi.ru}.
  One minute data are available on request from the corresponding author. The data are not publicly available for protection against unmonitored commercial use.

# conflictsofinterest: |
#   Declare conflicts of interest or state 'The authors declare no conflict of
#   interest.' Authors must identify and declare any personal circumstances or
#   interest that may be perceived as inappropriately influencing the
#   representation or interpretation of reported research results. Any role of the
#   funding sponsors in the design of the study; in the collection, analyses or
#   interpretation of data in the writing of the manuscript, or in the decision to
#   publish the results must be declared in this section. If there is no role,
#   please state 'The founding sponsors had no role in the design of the study;
#   in the collection, analyses, or interpretation of data; in the writing of the
#   manuscript, an in the decision to publish the results'.

# sampleavailability: |
#   Samples of the compounds ...... are available from the authors.

# supplementary: |
#  The following supporting information can be downloaded at:
#  \linksupplementary{s1}, Figure S1: title; Table S1: title; Video S1: title.

abbreviations:
  - short: DNI
    long: Direct beam/normal irradiance
  - short: CSid
    long: Clear sky identification algorithm
  - short: CUSUM
    long: Cumulative sum
  - short: SDR
    long: Solar downward radiation
  - short: SZA
    long: Solar zenith angle

header-includes:
   # - \usepackage{subfig}
   - \usepackage{subcaption}
   - \captionsetup[sub]{position=bottom, labelfont={bf, small, stretch=1.17}, labelsep=space, textfont={small, stretch=1.17}, aboveskip=6pt,  belowskip=-6pt, singlelinecheck=off, justification=justified}
   - \usepackage{placeins}

bibliography: manualreferences.bib

appendix:     appendix.tex

endnotes:     false

output:
  rticles::mdpi_article:
    extra_dependencies:  longtable
    keep_tex:            yes
  bookdown::word_document2: default
  bookdown::pdf_document2:
    number_sections:  no
    fig_caption:      yes
    keep_tex:         no
    latex_engine:     xelatex
    toc:              no
    toc_depth:        4
    fig_width:        7
    fig_height:       4.5
    documentclass:    article
    classoption:      a4paper,oneside
    fontsize:         12pt
    geometry:         "left=0.75in,right=0.75in,top=0.75in,bottom=0.75in"
    link-citations:   yes
    colorlinks:       yes
    urlcolor:         blue
    biblio-style:     apalike
---


```{r echo=F, include=T, warning=FALSE, message=FALSE}
suppressMessages(
    res <- rmarkdown::find_pandoc(dir = '/usr/lib/rstudio/resources/app/bin/quarto/bin/tools')
)
## document configurations
knitr::opts_chunk$set(comment    = ""      )
# knitr::opts_chunk$set(dev        = "pdf"   )
knitr::opts_chunk$set(out.width  = "70%"   )
knitr::opts_chunk$set(fig.align  = "center")
knitr::opts_chunk$set(fig.pos    = 'h!'    )
options(knitr.graphics.auto_pdf = FALSE)
library(pander)
library(data.table)
library(kableExtra)
library(dplyr)
## load data from trends analysis
# source("./DHI_GHI_00_raw_data.R")
# load(common_data)
load("./data/Input_1_longterm_trends.Rda")
## number of measurements for each dataset
SDR_N_All   <- sum(  ALL_1_daily_DESEAS[,GLB_att_N], na.rm = T)
SDR_N_Clear <- sum(CLEAR_1_daily_DESEAS[,GLB_att_N], na.rm = T)
SDR_N_Cloud <- sum(CLOUD_1_daily_DESEAS[,GLB_att_N], na.rm = T)

# CLEAR_1_daily_DESEAS[!is.na(GLB_att), .(sum(GLB_att_N), .N)]



## TSI data span info
TSIinfo <- data.table(read.csv("./figures/tbl_tsi_info.dat",
                    strip.white = TRUE,
                    sep = ";",
                    header = TRUE))
## variables we use in the analysis
source("./DHI_GHI_0_variables.R")

## create local citations file and links here
source("~/CODE/FUNCTIONS/R/gather_citations.R")
suppressMessages(
    gather_citations(
        sourcefile   = "./Article.Rmd",
        mainreposit  = "./Mainreferences.bib",
        localreposit = "./references.bib",
        folderlink   = "./References_links",
        workingdir   = "./"
    )
)


knitr::knit_hooks$set(extrawide = function(before, options, envir) {
    if (before) {
        return("\\begin{adjustwidth}{-\\extralength}{0cm}")
    } 
    
    if (!before) {
        return("\\end{adjustwidth}")
    }
    
    # else {
    #     
    #     output <- vector(mode = "character", length = options$fig.num + 1)
    #     
    #     for (i in 1:options$fig.num) {
    #         output[i] <- sprintf("\\includegraphics{%s}", fig_path(number = i))
    #     }
    #     
    #     output[i+1] <- "\\end{adjustwidth}"
    #     return(paste(output, collapse = ""))
    # }
})

```


# Introduction



The shortwave downward solar irradiance (SDR) at Earth's surface plays a significant role, on its climate.
Changes of the SDR can be related to changes on Earth's energy budget, the mechanisms of climate change, and water and carbon cycles [@Wild2009].
It can also affect solar and agricultural production, and all living organisms.
Studies of SDR variability, have identified some distinct SDR trends on different regions of the world on different time periods.
The term 'brightening' is generally used to describe periods of positive SDR trend, and 'dimming' for negative trend [@Wild2009].
There are many cases in the long term records of irradiance, showing a systematic change in the magnitude of the trend, occurring roughly in the last decades of the 20th century.
<!-- Trends china -->
On multiple stations in China, a dimming period was reported until about 2000, followed by a brightening period [@Yang2021].
<!-- Trends Europe Brazil -->
A similar pattern was identified, with the breaking point around 1980, for stations in Central Europe [@Wild2021] and Brazil [@Yamasoe2021].
<!-- Trends Global -->
On global scale, an artificial Intelligence aided spatial analysis on continental level with data from multiple stations reach similar conclusions for these regions and for the global trend [@Yuan2021].

There is a consensus among researchers that the major factor affecting the variability of SDR attenuation is the interactions of solar radiation with atmospheric aerosols and clouds.
Those interactions, among other factors, have been analysed with models [@Li2016; @Samset2018], showing the existence of feedback mechanisms between the two.
Similar findings have been shown in observational data [@Schwarz2020; @Ohvril2009; @Zerefos2009; @Xia2007 and references therein].
<!-- Sun variability: should cite that there is no significant trend found Wild2021 -->

Due to the significant spatial and temporal variability of the trends, and the contributing factors, there is a constant need to monitor and investigate SDR in different sites in order to estimate the degree of variability,  and its relation to the local conditions.
In this study, we examine the trends of SDR, using ground-based measurements at Thessaloniki, Greece, for the period `r year(min(ALL_1_daily_DESEAS$Date))` to `r year(max(ALL_1_daily_DESEAS$Date))`, as derived from a CM-21 pyranometer.
<!-- goals -->
We reevaluated and extended the dataset used by @Bais2013, we applied a different algorithm for the identification of clear-/cloud-sky instances [@Reno2016; @Reno2012a], and we derived the SDR trends for the period of study, under different sky conditions (all-sky, clear-sky and cloud-sky).
Finally, we investigated the dependence of the trends on solar zenith angle and season.


<!--
Aerosols interactions

#Yang2021  Cloud “shrinking” and “optical thinning” in the “dimming” period and a subsequent recovery in the “brightening” period over China

Aerosols not only strengthen but also weaken the
growth of clouds with respect to their coverage and
optical thickness, depending on the levels of pollution
and the associated amounts of aerosols as postulated
in a conceptual framework (Wild 2009a, 2012, Yang
et al 2012).

...... cloud formation occurrences and constitution nuclei. cite .....

#Wild2012 : simplify interaction nice graph
-->

# Data and methodology

The SDR data were measured with a Kipp & Zonen CM-21 pyranometer operating continuously at the Laboratory of Atmospheric Physics of the Aristotle University of Thessaloniki
($40^\circ\,38'\,$N, $22^\circ\,57'\,$E, $80\,$m\ a.s.l.) since 1993.
Here we use data for the period from
`r min(ALL_1_daily_DESEAS$Date)`
to
`r max(ALL_1_daily_DESEAS$Date)`.
The monitoring site is located
near the city centre thus we expect that measurements are affected by the urban environment.
During the study period, the pyranometer has been
independently calibrated three times at the Meteorologisches
Observatorium Lindenberg, DWD, verifying that stability of the
instrument's sensitivity is better than $0.7\%$ relative to the initial
calibration by the manufacturer. 
Along with SDR, the direct beam
radiation (DNI) is also measured with a collocated Kipp & Zonen CHP-1 pyrheliometer since 2016-04-01. 
The DNI data were used as auxiliary data
to support the selection of appropriate thresholds in the clear sky
identification algorithm (CSid), which is discussed later. It is noted
that the limited dataset of DNI was not used for the identification of
clear sky cases in the entire SDR series to avoid any selection bias due
to unequal length of the two datasets.
There are four distinct steps in the creation of the dataset analyzed here:
a)\ the acquisition of radiation measurements from the sensors,
b)\ the data quality check,
c)\ the identification of "clear sky" conditions from the radiometric data, and
d)\ the aggregation of data and trend analysis.



<!-- a) acquisition -->
For the acquisition of radiometric data, the signal of the pyranometer is sampled at a rate of $1\,\text{Hz}$.
The mean and the standard deviation of these samples are calculated and recorded every minute.
The measurements are corrected for the zero offset ("dark signal" in volts), which is calculated by averaging all measurements recorded for a period of $3\,\text{h}$, before (morning) or after (evening) the Sun reaches an elevation angle of $-10^\circ$.
The signal is converted to irradiance using a ramped value of the instrument’s sensitivity between  subsequent calibrations.

<!-- b) Radiation data quality check -->
A manual screening was performed, to remove inconsistent and erroneous recordings that can occur stochastically or systematically, during the continuous operation of the instruments.
The manual screening is aided by a radiation data quality assurance procedure, adjusted for the site, which is based on the methods of
Long and Shi\ [@Long2006; @Long2008a].
Thus, problematic recordings have been excluded from further processing.
Although it is impossible to detect all false data, the large number of available data, and the aggregation scheme we used, ensures the quality of the radiation measurements used in this study.

<!-- Data selection -->
Due to the significant measurement uncertainty when the Sun is near the horizon, we have excluded all measurements with SZA greater than $`r 90-MIN_ELEVA`^\circ$.
Moreover, due to obstructions around the site (hills and buildings) which block the direct irradiance, we excluded data with azimuth angle in the range
$`r FIBais_Az_1`^{\circ}$ - $`r FIBais_Az_2`^{\circ}$ and with SZA greater than $`r 90 -  FIBais_Elev`^{\circ}$.
<!-- 1au -->
To make the measurements comparable throughout the dataset, we adjusted all one-minute data to the mean Sun - Earth distance.
<!-- TSI -->
Subsequently, we adjusted all measurements to the Total Solar Irradiance (TSI) at $1\,\text{au}$, in order to compensate for the Sun's intensity variability, using a time series of satellite TSI observations.
The TSI data we used are part of the "NOAA Climate Data Record of Total Solar Irradiance" dataset [@Coddington2005].
The initial daily values of this dataset were interpolated to match the time step of our measurements.


<!-- c) Clear sky identification -->
In order to estimate the effect of the sky conditions on the long term variability of SDR, we created three datasets by characterizing each one-minute measurement with a corresponding sky-condition flag (i.e., all-sky, clear-sky and cloudy-sky).
To identify the clear-cases we used the method proposed by
@Reno2016, which requires the definition of some site specific parameters.
These parameters, were produced by an iterative process, as the original authors proposed and it are discussed in the next section.

<!-- CS subjectivity -->
We note that all methods have some subjectivity in the definition of clear or cloudy sky cases.
As a result, the details of the definition are site specific and they rely on a combination of thresholds and comparisons with ideal radiation models and statistical analysis of different signal metrics.
The CSid algorithm was calibrated with the main focus, to identify the presence of clouds. Despite the fine-tuning
of the procedure, in a few marginal cases false positive or false
negative results were identified by manual inspection. However, due to
their small number, they cannot affect the final results of the study.
For completeness, we provide below a brief overview of the clear-sky
identification algorithm (CSid), along with the site specific
thresholds.


```{r setup, echo=F, include=T, eval=TRUE}
## Load Clear Sky id v14.2 variables
MS <- data.frame(readRDS("~/CS_id/PARAMS/Clear_sky_id_Reno-Hansen_apply_v14_2.Rds"))
# export all Clear Sky variables
for (an in names(MS)) {
assign(an, MS[[an]])
}
## get TSI slope for reference
TSI <- data.table(read.csv("./figures/tbl_longterm_trends.dat",
           strip.white = TRUE,
           sep = ";",
           header = TRUE))
TSI <- TSI[grep("TSI", TSI$var), ]
TSI$slope.sd           <- NULL
TSI$slope.ConfInt_0.95 <- NULL
TSI$slope.ConfInt_0.99 <- NULL
TSI$var                <- NULL
TSI$N                  <- NULL
TSI$Obs                <- NULL
TSI$Rsqrd              <- NULL
TSI$RsqrdAdj           <- NULL


# TSI$cor.null_value     <- NULL
# TSI$cor.alternative    <- NULL
# TSI$cor.method         <- NULL
# TSI$cor.data_name      <- NULL
# TSI$cor.p              <- NULL
TSI$cor.conf_level      <- NULL
care <- grep("^cor\\.", names(TSI), value = T)
for (an in care) {
    TSI[, (an) := NULL ]
}

# setorder(TSI, -slope.stat_sig)
# rownames(TSI) <- NULL
# names(TSI) <- c("Trend [%/year]", "Trend p-value", "Sky condition", "Trend statistical signif. [%]")
# 
# TSIslopeAll <- TSI[`Sky condition` == "All sky cond."]
TSIslopeAll <- TSI[DATA == "All sky cond."]
```


## The clear sky identification algorithm

To calculate the reference clear-sky $\text{SDR}_\text{CSref}$ we used the $\text{SDR}_\text{Haurwitz}$ derived by the radiation model of @Haurwitz1945 (Eq.\ \ref{eq:hau}), adjusted for our site:
<!-- adjusted Haurwitz -->
\begin{equation}
\text{SDR}_\text{Haurwitz} = 1098 \times \cos(\theta) \times \exp \left( \frac{ - 0.057}{\cos(\theta)} \right) \label{eq:hau}
\end{equation}
where $\theta$ is the solar zenith angle (SZA).

The adjustment was made with a factor $a$ (Eq.\ \ref{eq:ahau}), which was estimated through an iterative optimization process, as described by @Long2000 and @Reno2016.
The target of the optimization was the minimization of a function $f(a)$ (Eq.\ \ref{eq:minf}) and was accomplished with the algorithmic function "optimise", which is an implementation based on the work of @Brent1973, from the library "stats" of the R programming language [@RCT2023].
<!-- cost function -->
\begin{equation}
f(a) = \frac{1}{n}\sum_{i=1}^{n} ( \text{SDR}_{\text{CSid},i} - a \times \text{SDR}_{\text{testCSref},i} )^2 \label{eq:minf}
\end{equation}
where: $n$ is the total number of daylight data, $\text{SDR}_{\text{CSid},i}$ are the data identified as clear sky by CSid, $a$ is a site-specific adjustment factor, and $\text{SDR}_{\text{testCSref},i}$ is the SDR derived by any of the
tested clear-sky radiation models.

The optimization and the selection of the clear sky reference model, was performed on SDR observations for the period 2016 - 2021.
During the optimization, eight simple clear sky radiation models were tested (namely, Daneshyar-Paltridge-Proctor, Kasten-Czeplak, Haurwitz, Berger-Duffie, Adnot-Bourges-Campana-Gicquel, Robledo-Soler, Kasten and Ineichen-Perez), with a wide range of factors.
These models are described in more details by @Reno2012 and evaluated by @Reno2016.
We found, that Haurwitz's model, adjusted with the factor $a = `r signif(alpha,3)`$ yields one of the lowest root mean squared errors (RMSE), while the procedure manages to characterize successfully the majority of the data.
Thus, our clear sky reference is derived by the Eq.\ \ref{eq:ahau}:
\begin{equation}
\text{SDR}_\text{CSref} = a \times \text{SDR}_\text{Haurwitz} = `r signif(alpha,3)` \times 1098 \times \cos(\theta) \times \exp \left( \frac{ - 0.057}{\cos(\theta)} \right) \label{eq:ahau}
\end{equation}

The criteria that were used to identify whether a measurement was taken under clear-sky conditions are presented below.
A data point is flagged as "clear-sky" if all criteria are satisfied; otherwise it is considered as "cloud-sky".
Each criterion was applied for a running window of $`r nt`$ consecutive one-minute measurements, and the characterization was assigned to the central datum of the window.
Each parameter, was calculated both from the observations and the reference clear sky model, for each comparison.
The allowable range of variation is defined by the model-derived value of the parameter multiplied by a factor plus an offset.
The factors and the offsets were determined empirically, by manually inspecting each filter's performance on selected days and adjusting them accordingly during an iterative process.
The criteria are
listed below, together with the range of values within which the
respective parameter should fall in order to raise the clear-sky flag:
<!-- 1. MeanVIP -->
<!-- ### Mean value of irradiance during the time period. -->
<!--a) Mean of the measured $\overline{\text{SDR}}_i$ = \text{mean}_{n=i-5}^{n=i+5}[\text{SDR}_{n}]$ and running mean of the reference $\overline{\text{SDR}}_{\text{CSref},i}$ = \text{mean}_{n=i-5}^{n=i+5}[\text{SDR}_{\text{CSref},n}]$ (Eq. \ref{eq:MeanVIP}).-->

a) Mean of the measured $\overline{\text{SDR}}_i$ (Eq. \ref{eq:MeanVIP}).
\begin{equation}
`r 1 - CS_ref_rm_VIP_RelLow` \times \overline{\text{SDR}}_{\text{CSref},i} - `r CS_ref_rm_VIP_LowOff`\,Wm^{-2}
< \overline{\text{SDR}}_i <
`r 1 + CS_ref_rm_VIP_RelUpp` \times \overline{\text{SDR}}_{\text{CSref},i} + `r CS_ref_rm_VIP_UppOff`\,Wm^{-2}
\label{eq:MeanVIP}
\end{equation}
<!-- 2. MaxVIP -->
<!-- ### Max value of irradiance during the time period. -->
<!-- The running max measured value $M_{\text{SDR},i} = \max_{n=i-5}^{n=i+5}[\text{SDR}_{n}]$, is compared to a similar constructed value from the reference $M_{CSrefi} = \max_{n=i-5}^{n=i+5}[\text{SDR}_{\text{CSref},n}]$ (Eq.\ \ref{eq:MaxVIP}). -->
b) Maximum measured value $M_{i}$ (Eq.\ \ref{eq:MaxVIP}).
\begin{equation}
`r MaxVIP_fct` \times M_{\text{CSref},i} - `r MaxVIP_off_low`\,Wm^{-2}
< M_{i} <
`r MaxVIP_fct` \times M_{\text{CSref},i} + `r MaxVIP_off_upp`\,Wm^{-2}
\label{eq:MaxVIP}
\end{equation}
<!-- 3. VIL -->
<!-- ### Variability in irradiance by line length. -->
c) Length $L_i$ of the sequential line segments, connecting the points of the $`r nt`$ SDR values (Eq. \ref{eq:VILeq}).
\begin{equation}
L_i = \sum_{i=1}^{n-1}\sqrt{\left ( \text{SDR}_{i+1} - \text{SDR}_{i}\right )^2 + \left ( t_{i+1} - t_i \right )^2}
\label{eq:VILeq}
\end{equation}
\begin{equation}
`r MinVIL_fct` \times L_{\text{CSref},i} - `r offVIL_dwl` < L_i < `r MaxVIL_fct` \times L_{\text{CSref},i} + `r offVIL_upl`
\label{eq:VILcr}
\end{equation}
where: $t_i$ is the time stamp of each SDR measurement.
<!-- 4. VCT -->
<!-- ### Variance of Changes in the Time series. -->
<!-- Standard deviation of rate of change in irradiance. -->
d) Standard deviation $\sigma_i$ of the slope ($s_i$) between the $`r nt`$ sequential points, normalized by the mean $\overline{\text{SDR}}_i$ (Eq.\ \ref{eq:VCT1}).
<!-- \begin{gather}
\bar{s} = \frac{1}{n-1} \sum_{i=1}^{n-1} s_i \label{eq:VCT2} \\
\sigma_i = \frac {\sqrt{\frac{1}{n-1} \sum_{i=1}^{n-1} \left( s_i - \bar{s} \right)^2} } {\bar{G_i}} \label{eq:VCT3}
\end{gather} -->
\begin{gather}
  \sigma_i = \frac {\sqrt{\frac{1}{n-1} \sum_{i=1}^{n-1} \left( s_i - \bar{s} \right)^2}} {\overline{\text{SDR}}_i} \label{eq:VCT1} \\
  s_i = \frac{\text{SDR}_{i+1} - \text{SDR}_{i}}{t_{i+1} - t_i},\;\;   \bar{s} = \frac{1}{n-1} \sum_{i=1}^{n-1} s_i,\;\;\forall i \in \left \{ 1, 2, \ldots, n-1 \right \}\;\;
\end{gather}
For this criterion, $\sigma_i$ should be below a certain threshold (Eq.\ \ref{eq:VCTcr}):
\begin{equation}
  \sigma_i < `r offVCT` \label{eq:VCTcr}
\end{equation}
<!-- 5. VSM -->
<!-- ### Variability in the Shape of the irradiance Measurements. -->
e) Maximum difference $X_i$ between the change in measured irradiance and the change in clear sky irradiance over each measurement interval.
\begin{gather}
  X_i = \max{\left \{ \left | x_i - x_{\text{CSref},i} \right | \right \}} \label{eq:VSM3} \\
  x_i = \text{SDR}_{i+1} - \text{SDR}_{i} \forall i \in \left \{ 1, 2, \ldots, n-1 \right \} \label{eq:VSM1} \\
  x_{\text{CSref},i} = \text{SDR}_{\text{CSref},i+1} - \text{SDR}_{\text{CSref},i} \forall i \in \left \{ 1, 2, \ldots, n-1 \right \} \label{eq:VSM2}
\end{gather}
For this criterion, $X_i$ should be below a certain threshold (Eq.\ \ref{eq:VSMcr}):
\begin{equation}
  X_i < `r offVSM`\,Wm^{-2} \label{eq:VSMcr}
\end{equation}


In the final dataset
<!-- $`r SDR_N_All`$ -->
$`r signif(100 * SDR_N_Clear / SDR_N_All, 3)`\%$
of the 1-minute data were identified as under clear-sky conditions and
$`r signif(100 * SDR_N_Cloud / SDR_N_All, 3)`\%$
as under cloud-sky conditions.
<!-- The TSI data we use, is a combination of data from NOAA [@Coddington2005] (for `r as.Date(TSIinfo[TSI_Source == "NOAA", Start])` - `r as.Date(TSIinfo[TSI_Source == "NOAA", End])`) and adjusted data from @LASP2023 (for `r as.Date(TSIinfo[TSI_Source != "NOAA", Start])` - `r as.Date(TSIinfo[TSI_Source != "NOAA", End])`).-->




## Aggregation of data and statistical approach {#aggregationstatistical}

In order to investigate the SDR trends which are the main focus of the
study, we implemented an appropriate aggregation scheme to the
one-minute data to derive a series in coarser time-scales.
To preserve the representativeness of the data we used the following criteria:
<!-- a) for daily mean values we exclude days with less than `r Daily_aggregation_N_lim` valid data points, -->
a) we excluded all days with less than `r 100 * All_daily_ratio_lim`% of the expected daytime measurements,
b) daily means for the clear-sky and cloudy-sky datasets
were calculated only for days with more than
`r 100 * Clear_daily_ratio_lim`% of the expected daytime
measurements identified as clear or cloudy respectively,
c) monthly means were computed from daily means, for all-skies dataset 
means were computed only when at least `r Monthly_aggegation_N_lim` 
days of the month were available.
Seasonal means were derived by averaging the
monthly mean values in each season (winter: December - February, spring:
March - May, etc.).
The daily and monthly climatological means were
derived by averaging the data for each day of year and calendar month,
respectively. The daily and monthly datasets were deseasonalized by
subtracting the corresponding climatological annual cycle (daily or
monthly) from the actual data. Finally, to estimate the SZA effect on
the SDR trends, the one-minute data were aggregated in $1^{\circ}$ SZA
bins, separately for the morning and afternoon hours.

The linear trends were calculated using an first order autoregressive model
 with lag of 1 day with fitting method of the "maximum likelihood" [@Gardner1980; @Jones1980], by implementing the function "arima" from the library "stats" of the R programming language [@RCT2023]. The trends were reported together with the $2\sigma$ errors (Table\ \ref{tab:trendtable}).

<!-- [For the trends derived from monthly mean data we used an effective -->
<!-- number of observations to calculate the standard error (Sander et al., -->
<!-- 2000) in order to assess the significance of the trends.]{.mark} -->
<!-- @Santer2000 -->


# Results

## Long-term SDR trends

```{r echo=F, eval=TRUE}
LT <- data.table(read.csv("./figures/tbl_longterm_trends.dat",
               strip.white = TRUE,
               sep = ";",
               header = TRUE))
LT <- LT[grep("SDR", LT$var), ]
LT$slope.sd           <- NULL
LT$slope.ConfInt_0.95 <- NULL
LT$slope.ConfInt_0.99 <- NULL
LT$var                <- NULL
# LT$N                  <- NULL
LT$Obs                <- NULL
setorder(LT, -slope.stat_sig)
rownames(LT) <- NULL

LT$cor.df           <- NULL
# LT$cor.null_value   <- NULL
# LT$cor.alternative  <- NULL
# LT$cor.method       <- NULL
# LT$cor.data_name    <- NULL
# LT$cor.p            <- NULL
LT$cor.conf_level   <- NULL
LT$cor.conf_int_1   <- NULL
LT$cor.conf_int_2   <- NULL


## some vars to use later
alltrend   <- signif(LT[DATA == "All sky cond.",    slope], 2)
cleartrend <- signif(LT[DATA == "Clear sky cond.",  slope], 2)
cloudtrend <- signif(LT[DATA == "Cloudy sky cond.", slope], 2)
LTminSSig  <- signif(min(LT$slope.stat_sig), 4)

## numeric precision of table
LT$slope           <- signif(LT$slope,               2)
LT$slope.p         <- signif(LT$slope.p,             3)
LT$Rsqrd           <- signif(LT$Rsqrd,               2)
LT$Tmod_Estimate   <- signif(LT$Tmod_Estimate,       2)
LT$cor.estimate    <- signif(LT$cor.estimate,        2)
LT$Tmod_Std..Error <- signif(LT$Tmod_Std..Error * 2, 2)
LT$ChangeWpY       <- signif(LT$ChangeWpY,           3)
LT$slope <- format(LT$slope, 3, drop0trailing = T)


LT$RsqrdAdj <- NULL
LT$cor.t    <- NULL
LT$Rsqrd    <- NULL

## rename sky conditions
LT$DATA <- sub(" cond.", "", LT$DATA)
LT$DATA <- sub(" sky", " skies", LT$DATA)

LT <- LT[order(LT$DATA),]



# LT <- rename(LT, "Trend [%/year]" = slope        )
LT <- rename(LT, "Sky conditions"  = DATA         )
LT <- rename(LT, "Days"            = N            )
LT <- rename(LT, "Pearson cor."    = cor.estimate )
LT <- rename(LT, "Trend p-value"   = slope.p      )
LT <- rename(LT, "Trend [%/year]"  = Tmod_Estimate) # Arima slope
LT <- rename(LT, "Trend S.E."      = Tmod_Std..Error )
LT <- rename(LT, "Trend [W/year]"  = ChangeWpY )

LT$slope.stat_sig  <- NULL
LT$`Trend p-value` <- NULL
LT$N_eff           <- NULL
LT$slope           <- NULL
LT$t_eff           <- NULL
LT$t_eff_cri       <- NULL
LT$conf_2.5        <- NULL
LT$conf_97.5       <- NULL
LT$mean_clima      <- NULL
LT$Tmod_z.value    <- NULL
LT$Tmod_Pr...z..   <- NULL


## order columns
LT1 <- LT[,c(
      "Sky conditions",
      "Trend [%/year]",
      "Trend S.E.",
      "Pearson cor.",
      "Trend [W/year]",
      "Days"
      )]
# LT1 <- LT


# signif(LT1$`Trend [%/year]` , 3)
# round(LT1$`Trend [%/year]` , 3)
# format(LT1$`Trend [%/year]` , 3, drop0trailing = T)
# as.character(format(LT1$`Trend [%/year]` , 3))


## order columns
# LT2 <- LT[,c(
#       "Sky conditions",
#       "Trend [%/year]",
#       "Statistical signif. [%]",
#       "Days with data"
#       )]
LT2 <- LT
```

We calculated the linear trends of SDR, from the departures of the mean daily values from the daily climatology and for the three sky conditions (Table\ \ref{tab:trendtable}).
In Figure\ \ref{fig:trendALL} we present only the time series under all-sky conditions; the plots for clear-sky and cloud-sky conditions, are shown in the Appendix (Figures\ \ref{fig:trendCLEAR} and\  \ref{fig:trendCLOUD}).
In the studied period, there is no
significant break or change in the variability pattern of the time
series.
The linear trends in all three datasets are positive and around
$0.4\,\%/y$ for all-sky and cloudy-sky conditions, while for clear-skies the
trend is much smaller (\~$`r signif(cleartrend,1)`\,\%/y$). 
The linear trends were calculated
taking into account the autocorrelation of the time series and all three
are statistically significant at least at the $95\,\%$ confidence level, as
they are larger than the corresponding $2\sigma$ errors.
The clear-sky trend is
very small suggesting a small effect from aerosols and water vapor which
are the dominant factors of the SDR variability. 
In contrast the large
positive trend of SDR under cloudy skies can be attributed to reduction
in cloud cover and/or cloud optical depth. 
Lack of continuous cloud
observations that could support these findings does not allow drawing
firm conclusions. However, there are indications that the total
cloud-cover as inferred from the ERA5 analysis for the grid point of
Thessaloniki is decreasing over the period of study.

<!-- ($`r alltrend`\,\%/y$), a very close but smaller trend for clear-skies ($`r cleartrend`\,\%/y$) and a negative weaker trend for cloudy-skies ($`r cloudtrend`\,\%/y$). -->
The all-sky trend is similar to the one reported in @Bais2013
from a ten-year shorter dataset suggesting that the tendency of SDR in
Thessaloniki is systematic.
Other studies for the European region reported a change in the SDR trend
around 1980 from negative to positive
with comparable magnitude [@Wild2021; @Yuan2021; @Ohmura2009], 
well before the start of our records.
However, the
trends reported here for the three datasets are in accordance with the
widely accepted solar radiation brightening over Europe.
For the period
of our observations the trend in the TSI is negligible
($`r format(TSIslopeAll[1,1], scientific = F, digits = 2)`\,\%/y$),
and thus we cannot attribute any significant effect
on the SDR trend to solar variability.


```{r trendtable, echo=F}
# names(LT1)
# "Sky conditions", "Trend [%/year]", "Trend S.E.", "Pearson cor.", "Trend [W/year]", "Days" 
x_latex <- knitr::kable(LT1,
                        format      = "latex",
                        booktabs    = TRUE,
                        escape      = FALSE,
                        col.names   = c("Sky conditions", "Trend [\\%/year]", "Trend S.E. ($2\\sigma$)", "Pearson correl.", "Trend [W/m\\textsuperscript{2}/year]", "Days"),
                        format.args = list(digits = 3),
                        linesep     = "",
                        align       = "crrrrr",
                        centering   = FALSE,
                        table.envir = "table",
                        position    = "H",
                        drop0trailing = T,
                        caption     = paste0("Trends in SDR daily means for different sky conditions for the period ", year(min(ALL_1_daily_DESEAS$Date)), " - ", year(max(ALL_1_daily_DESEAS$Date)), "."))

# x_latex %>%
#     kable_styling(
#         latex_options = c("hold_position")
#     )
x_latex %>%
    kable_styling(full_width = TRUE) %>%
    column_spec(1, width = "8em")
```


```{r trendALL, echo=F, out.width='.75\\linewidth', fig.cap=paste0("Anomalies (\\%) of the daily all-sky SDR from the climatological mean for the period ", year(min(ALL_1_daily_DESEAS$Date)), " -- ", year(max(ALL_1_daily_DESEAS$Date)), ". The black line is the long term linear trend.")}
knitr::include_graphics("./images/LongtermTrends-1.png")
```

Although the year-to-year variability of the anomalies (Figure \ref{fig:trendALL} and Figures\ \ref{fig:trendCLEAR}, \ref{fig:trendCLOUD} in Appendix), shows a rather homogeneous behaviour, plots of the cumulative sums (CUSUM) [@Regier2019] of the anomalies can reveal different structures in the records of all three sky conditions.
For time series with a uniform trend, we would expect
the CUSUMs of the anomalies to have a symmetric 'V' shape centered
around the middle of the series. This would indicate that the anomalies
are evenly distributed around the climatological mean, and for a
positive uniform trend, the first half is below and the second half
above the climatological mean.
In our case, there is a more complex
evolution of the anomalies.
For all-skies (Figure\ \ref{fig:cusummonth-1}),
we observe three
rather distinct periods: a) a downward part between the start of the
datasets and about 2000, denoting that all anomalies are negative thus
below the climatology; b) a relatively steady part lasting for almost 20
years suggesting little variability in SDR anomalies; and c) a steep
upward part to present indicating anomalies above the climatology. The
CUSUMs for cloudy-skies (Figure\ \ref{fig:cusummonth-3}), show a similar behavior with some short-term
differences that do not change the overall pattern.
For clear skies
(Figure\ \ref{fig:cusummonth-2}), a monotonic downward tendency is evident until 2004,
suggesting that the anomalies are all negative. After 2004 the anomalies
turn to positive at a fast rate for about five years and at a slower
rate thereafter.
 

\begin{figure}[h!]
    \begin{adjustwidth}{-\extralength}{0cm}
        {\centering 
        \subfloat[All skies.\label{fig:cusummonth-1}]
            {\includegraphics[width=.32\linewidth]{./images/CumulativeMonthlyCuSum-1}}\hfill
        \subfloat[Clear skies.\label{fig:cusummonth-2}]
            {\includegraphics[width=.32\linewidth]{./images/CumulativeMonthlyCuSum-5}}\hfill
        \subfloat[Cloudy skies.\label{fig:cusummonth-3}]
            {\includegraphics[width=.32\linewidth]{./images/CumulativeMonthlyCuSum-9}}\hfill
        }
\caption{Cumulative sum plots of the monthly SDR anomalies in (\%) for different sky conditions.}\label{fig:cusummonth}
\end{adjustwidth}
\end{figure}


<!-- ```{r cusummonth, echo = FALSE, fig.cap='Cumulative sum plots of the monthly SDR anomalies in (%) for different sky conditions.', fig.subcap=c('All skies.', 'Clear skies.', 'Cloudy skies.'), out.width='.32\\linewidth', fig.asp=1, fig.ncol = 3} -->
<!-- knitr::include_graphics(c( -->
<!--     "./images/CumulativeMonthlyCuSum-1.png",    # ALL sky -->
<!--     "./images/CumulativeMonthlyCuSum-5.png",    # CLEAR sky -->
<!--     "./images/CumulativeMonthlyCuSum-9.png"))   # Cloud sky -->
<!-- ``` -->

In order to unveil further the features of the variability of the three
datasets, Figure\ \ref{fig:cusumnotrendmonthly}
presents another set of CUSUM plots using anomalies
after the long-term linear trend is removed. With this approach, periods
when the CUSUMs diverge from zero can be interpreted as a systematic
variation of SDR from the climatological mean. When the CUSUM is
increasing, the anomalies values are above the climatology and vice
versa. 
Overall, for all- and cloudy-sky conditions (Figures\ \ref{fig:cusumnotrendmonthly-1} and\ \ref{fig:cusumnotrendmonthly-3}) we
observe periods with anomalies diverging from the climatological values,
each lasting for several years. These fluctuations are probably within
the natural variability and no distinct changes are identified. The
pattern in both datasets is similar, suggesting prevalence in cloudy
skies over Thessaloniki.
For clear skies (Figure\ \ref{fig:cusumnotrendmonthly-2}) the distinct change
in 2004 is now clearer. The most likely reason for this change is the
monotonic reduction of aerosols in Thessaloniki. At that year there a
change in the rate of decrease in aerosol optical depth as illustrated
in Figure 7 of @Siomos2020. This abrupt change in CUSUMs lasts
until about 2010 when the anomalies become again variable.


\begin{figure}[h!]
    \begin{adjustwidth}{-\extralength}{0cm}
        {\centering 
            \subfloat[All skies.\label{fig:cusumnotrendmonthly-1}]
                {\includegraphics[width=.32\linewidth]{./images/CumulativeMonthlyCuSumNOtrend-1} }\hfill
            \subfloat[Clear skies.\label{fig:cusumnotrendmonthly-2}]
                {\includegraphics[width=.32\linewidth]{./images/CumulativeMonthlyCuSumNOtrend-5} }\hfill
            \subfloat[Cloudy skies.\label{fig:cusumnotrendmonthly-3}]
                {\includegraphics[width=.32\linewidth]{./images/CumulativeMonthlyCuSumNOtrend-9} }
        }
        \caption{Cumulative sum plots of monthly SDR anomalies in (\%) for different sky conditions after removing the long-term linear trend.}\label{fig:cusumnotrendmonthly}
\end{adjustwidth}
\end{figure}


<!-- ```{r cusumnotrendmonthly, echo = FALSE, fig.cap='Cumulative sum plots of monthly SDR anomalies in (%) for different sky conditions after removing the long-term linear trend.', fig.subcap=c('All skies.', 'Clear skies.', 'Cloudy skies.'), out.width='.32\\linewidth', fig.asp=1, fig.ncol = 3} -->
<!-- knitr::include_graphics(c( -->
<!--     "./images/CumulativeMonthlyCuSumNOtrend-1.png",    # ALL sky -->
<!--     "./images/CumulativeMonthlyCuSumNOtrend-5.png",    # CLEAR sky -->
<!--     "./images/CumulativeMonthlyCuSumNOtrend-9.png"))   # Cloud sky -->
<!-- ``` -->


<!-- ```{r cusum, echo = FALSE, fig.cap='Running cumulative sum plots of the daily SDR.', fig.subcap=c('All-sky conditions.', 'Clear-sky conditions.', 'Cloud-sky conditions.'), out.width='.32\\linewidth', fig.asp=1, fig.ncol = 3} -->
<!-- knitr::include_graphics(c( -->
<!--     "./images/CumulativeDailyCuSum-1.png",    # ALL sky -->
<!--     "./images/CumulativeDailyCuSum-5.png",    # CLEAR sky -->
<!--     "./images/CumulativeDailyCuSum-9.png"))   # Cloud sky -->
<!-- ``` -->

<!-- ```{r cusumnotrend, echo = FALSE, fig.cap='Running cumulative sum plots of the daily SDR after removing the long term trend from the daily values.', fig.subcap=c('All-skies.', 'Clear-skies.', 'Cloud-skies.'), out.width='.32\\linewidth', fig.asp=1, fig.ncol = 3} -->
<!-- knitr::include_graphics(c( -->
<!--     "./images/CumulativeDailyCuSumNOtrend-1.png",    # ALL sky -->
<!--     "./images/CumulativeDailyCuSumNOtrend-5.png",    # CLEAR sky -->
<!--     "./images/CumulativeDailyCuSumNOtrend-9.png"))   # Cloud sky -->
<!-- ``` -->

<!-- ```{r cusumSTD, echo = FALSE, fig.cap='two plots', fig.subcap=c('one plot', 'the other one'), out.width='.32\\linewidth', fig.asp=1, fig.ncol = 3} -->
<!-- knitr::include_graphics(c( -->
<!--     "./images/CumulativeDailyCuSumSTD-1.png",    # ALL sky -->
<!--     "./images/CumulativeDailyCuSumSTD-2.png",    # CLEAR sky -->
<!--     "./images/CumulativeDailyCuSumSTD-3.png"))   # Cloud sky -->
<!-- ``` -->



## Effects of the solar zenith angle on SDR

The solar zenith angle is a major factor affecting the SDR, since
increases in SZA leads to enhancement of the radiation path in the
atmosphere, especially in urban environments with human activities
emitting aerosols 
[@Wang2021].
In order to estimate the effect of SZA on the SDR trends, we grouped the data in bins of $1^\circ$ SZA, and calculated the overall trend for each bin, separately for the daily
periods before noon and after noon (Figure\ \ref{fig:szatrends}).
Although there are seasonal dependencies of the minimum SZA (see Appendix, Figure\ \ref{fig:SZAtrendSeason}), these dependencies are not discussed further.

For all-sky conditions the brightening effect of SDR (positive trend) increases with SZAs (Figures\ \ref{fig:szatrends-1})
ranging from about $0.1\,\%/y$ to
about $0.7\,\%/y$ for the statistically significant trends.
The trends in the morning and afternoon hours are more or
less consistent with small differences at small SZAs which can be
attributed to effects on clear sky SDR from systematic diurnal patterns
of aerosols during the warm period of the year, consistently with the results reported for China by @Wang2021. 
Note that SZAs less than $25^\circ$ can only occur during the warm period of the year around noon when clear skies are more
frequent. The increasing of the trend with SZA is likely caused by the
increased attenuation of SDR with SZA. The effect is larger when aerosol
and/or cloud layers are optically thicker, therefore, decreases in
aerosol and clouds through the study period will result in larger
positive trends of SDR at larger SZAs.

Under clear skies (Figures\ \ref{fig:szatrends-2}), the trends are smaller and less variable,
ranging between $0.1$ and $0.15\,\%/y$ up to $77^\circ$ SZA.
At higher SZAs and in
the afternoon hours there a sharp increase in the trend up to $0.3\,\%/y$,
which may have been caused by the long path length of radiation through
the atmosphere as discussed above for the all-sky conditions. The small
differences in the trend between morning and afternoon between $35$ and
$60^\circ$ SZA is likely a result of less attenuation of SDR in the morning
hours due to lesser amounts of aerosols and shallower boundary layer.

For cloudy-sky conditions (Figure\ \ref{fig:szatrends-3}), we can not discern any significant dependence of the SDR trend with SZA as the variability of irradiance is
dominated by the cloud effects leading to insignificant
trends. Statistically significant trends appear only in the afternoon and
for SZAs larger than $60^\circ$.
The sharp increase of the trend at SZAs
larger than $\sim{75}^{\circ}$, observed also for clear skies, is
probably associated with stronger attenuation by clouds under oblique
incidence angles, which result also in smaller variability.


\begin{figure}[h!]
    \begin{adjustwidth}{-\extralength}{0cm}
        {\centering 
            \subfloat[All skies.\label{fig:szatrends-1}]
                {\includegraphics[width=.32\linewidth]{./images/SzaTrends-1}}\hfill
            \subfloat[Clear skies.\label{fig:szatrends-2}]
                {\includegraphics[width=.32\linewidth]{./images/SzaTrends-4}}\hfill
            \subfloat[Cloudy skies.\label{fig:szatrends-3}]
                {\includegraphics[width=.32\linewidth]{./images/SzaTrends-7}}
        }
        \caption{Long term trends of SDR as a function of SZA separately from morning and afternoon periods. Solid shapes  represent statistically significant trends ($p < 0.005$).}\label{fig:szatrends}
    \end{adjustwidth}
\end{figure}


<!-- ```{r szatrends, echo = FALSE, fig.cap='Long term trends of SDR as a function of SZA separately from morning and afternoon periods. Solid shapes  represent statistically significant trends ($p < 0.005$).', fig.subcap=c('All skies.', 'Clear skies.', 'Cloudy skies.'), out.width='.32\\linewidth', fig.asp=1, fig.ncol = 3} -->
<!-- knitr::include_graphics("./images/SzaTrends-1.png") -->
<!-- knitr::include_graphics("./images/SzaTrends-4.png") -->
<!-- knitr::include_graphics("./images/SzaTrends-7.png") -->
<!-- ``` -->

<!-- ```{r szatrendsmonthly, echo = FALSE, fig.cap='*** Montlhly *** Distribution of the SDR\'s long term trends by SZA before and after noon. The solid data points represent values with an acceptable statistical significance ($p<0.005$).', fig.subcap=c('All-sky conditions.', 'Clear-sky conditions.', 'Cloud-sky conditions.'), out.width='.32\\linewidth', fig.asp=1, fig.ncol = 3} -->
<!-- knitr::include_graphics("./images/SzaTrendsMonthly-1.png") -->
<!-- knitr::include_graphics("./images/SzaTrendsMonthly-4.png" ) -->
<!-- knitr::include_graphics("./images/SzaTrendsMonthly-7.png") -->
<!-- ``` -->


## Long term trends by season

```{r echo=F, eval=TRUE}
## Prepare table and data

# spp <- read.csv("./figures/tbl_longterm_trends_season.dat",
#                strip.white = TRUE,
#                sep         = ";",
#                header      = TRUE)
spp <- read.csv("./figures/tbl_longterm_trends_season_byM.dat",
               strip.white = TRUE,
               sep         = ";",
               header      = TRUE)

spp <- spp[grep("SDR" ,spp$var), ]
spp$N_eff              <- NULL
spp$Rsqrd              <- NULL
spp$RsqrdAdj           <- NULL
spp$conf_2.5           <- NULL
spp$conf_97.5          <- NULL
spp$cor.alternative    <- NULL
spp$cor.conf.level     <- NULL
spp$cor.conf_int_1     <- NULL
spp$cor.conf_int_2     <- NULL
spp$cor.conf_level     <- NULL
spp$cor.data_name      <- NULL
spp$cor.df             <- NULL
spp$cor.method         <- NULL
spp$cor.null_value     <- NULL
spp$cor.p              <- NULL
spp$cor.t              <- NULL
spp$slope.ConfInt_0.95 <- NULL
spp$slope.ConfInt_0.99 <- NULL
spp$slope.sd           <- NULL
spp$t_eff              <- NULL
spp$t_eff_cri          <- NULL
spp$var                <- NULL
rownames(spp)          <- NULL

## order by season
target    <- c("Winter", "Spring", "Summer", "Autumn")
new_order <- sapply(target, function(x, spp){which(spp$Season == x)}, spp = spp)
spp       <- spp[new_order,]
## order by sky condition
spp <- spp[order(spp$DATA), ]

## numeric precision
spp$Tlm_Std..Error  <- round(spp$Tlm_Std..Error * 2, 2)
spp$slope           <- round(spp$slope,              2)
spp$slope.p         <- round(spp$slope.p,            3)
spp$cor.estimate    <- round(spp$cor.estimate,       2)
# spp$slope.stat_sig  <- signif(spp$slope.stat_sig, 3)
# spp$Rsqrd           <- signif(spp$Rsqrd,          3)

# spp$Tlm_Pr...t..

## rename sky conditions
spp$DATA <- sub(" cond.", "", spp$DATA)
## rename conditions
spp$DATA <- sub(" sky", " skies", spp$DATA)

spp <- rename(spp, "Trend [%/year]"  = slope          )
spp <- rename(spp, "Trend p-value"   = slope.p        )
spp <- rename(spp, "Sky condition"   = DATA           )
spp <- rename(spp, "Pearson correl." = cor.estimate   )
spp <- rename(spp, "Trend S.E."      = Tlm_Std..Error )

## arrange columns
spp <- spp[,c(
      "Sky condition",
      "Season",
      "Trend [%/year]",
      "Trend S.E.",
      "Pearson correl.",
      "Trend p-value"
      )]

# ## put all sky first
# A  <- which(spp$`Sky condition` == "All sky cond.")
# B  <- which(spp$`Sky condition` != "All sky cond.")
# spp <- spp[c(A,B),]

```


Similarly to the long term trends from daily means of SDR discussed above, we have calculated the trend for the three sky conditions and for each season of the year, using the corresponding mean monthly anomalies
(Figure\ \ref{fig:seasonalALL} and Table\ \ref{tab:trendseasontable}).
<!-- all sky -->
For all-sky conditions the trend in SDR in winter is the largest
($`r signif(spp$"Trend [%/year]"[spp$Season == "Winter" & spp$"Sky condition" == "All skies"], 2)`\,\%/y$),
followed by the trend in autumn
($`r signif(spp$"Trend [%/year]"[spp$Season == "Autumn" & spp$"Sky condition" == "All skies"], 2)`\,\%/y$,
a value close to the long term trend) both statistically significant at the $95\,\%$ confidence level.
In spring and summer, the trends are much smaller and of lesser statistical significance.
These seasonal differences indicate a possible relation of the trends in SDR to trends in clouds during winter and autumn.
<!-- clear sky -->
For clear-skies, the trend in winter is $`r signif(spp$"Trend [%/year]"[spp$Season == "Winter" & spp$"Sky condition" == "Clear skies"], 2)`\,\%/y$, and is 
associated with the decreasing trend in
aerosol optical depth [@Siomos2020], and almost half of that for
all-skies, which is another indication of a decreasing trend in cloud
optical thickness. 
<!-- clear sky -->
In other seasons the clear-sky trend is still very small
(below $0.1\,\%/y$). 
<!-- cloud dsky -->
Finally, for cloud-skies the
winter trend is the largest 
($`r signif(spp$"Trend [%/year]"[spp$Season == "Winter" & spp$"Sky condition" == "Cloudy skies"], 2)`\,\%/y$)
and greater than for all-skies,
followed by a much smaller trend in autumn 
($`r signif(spp$"Trend [%/year]"[spp$Season == "Autumn" & spp$"Sky condition" == "Cloudy skies"], 2)`\,\%/y$).
<!-- ($`r signif(spp$"Trend [%/year]"[spp$Season == "Winter" & spp$"Sky condition" == "All skies"], 2)`\,\%/y$) -->


The trends under clear- and cloudy-sky conditions are of the same
direction and it would be expected that their sum is similar to the
all-sky trend. This does not happen, especially for winter, likely due
to the way the monthly means for clear and cloudy skies were calculated.
Daily means were calculated only when at least $60\,\%$ of the clear- or
cloudy-sky data were available (see sect. \ref{aggregationstatistical}).


\begin{figure}[h!]
    \begin{adjustwidth}{-\extralength}{0cm}
        {\centering 
            \includegraphics[width=1\linewidth]{./images/SeasonalMTrendsTogether3-2}   % Seasonal from Monthly
        }
        \caption{Linear trends (black lines) of monthly mean anomalies of SDR by season (rows of plots) for the three sky conditions (columns of plots).}\label{fig:seasonalALL}
    \end{adjustwidth}
\end{figure}

<!-- % \includegraphics[width=1\linewidth]{./images/SeasonalTrendsTogether3-2}  % Seasonal from Daily -->

<!-- ```{r seasonalALL, echo=F, fig.cap="Linear trends (black lines) of monthly mean anomalies of SDR by season (rows of plots) for the three sky conditions (columns of plots).", out.width="100%"} -->
<!-- knitr::include_graphics("./images/SeasonalTrendsTogether3-2.png") -->
<!-- ``` -->

<!-- ```{r seasonalALL, echo=F, fig.cap="Trends by season for all-sky condition. Displays monthly means of daily means."} -->
<!-- knitr::include_graphics("./images/SeasonalTrends-1.png") -->
<!-- ``` -->

<!-- ```{r seasonalCLEAR, echo=F, fig.cap="Trends by season for clear-sky condition. Displays monthly means of daily means."} -->
<!-- knitr::include_graphics("./images/SeasonalTrends-2.png") -->
<!-- ``` -->

<!-- ```{r seasonalCLOUD, echo=F, fig.cap="Trends by season for Cloudy-sky condition. Displays monthly means of daily means."} -->
<!-- knitr::include_graphics("./images/SeasonalTrends-3.png") -->
<!-- ``` -->





```{r trendseasontable, echo=F}

spp2 <- spp

# names(spp2)
# col.names   = c("Sky conditions", "Trend [\\%/year]", "Trend S.E. ($2\\sigma$)", "Pearson correl.", "Trend [W/m\\textsuperscript{2}/year]", "Days"),

# sub("Trend S.E.", "Trend S.E. ($2\\sigma$)", names(spp2))

# panderOptions("table.alignment.default", "left")
# panderOptions("table.alignment.default", "center")
# pander(spp,
#        justify = c('center', 'right', 'right', 'center'),
#        split.table = Inf,
#        caption = "\\label{tab:trendseasontable}SDR linear trends of monthly anomalies for each season of the year.")

## use kable
x_latex <- knitr::kable(spp2,
                        format      = "latex",
                        booktabs    = TRUE,
                        escape      = FALSE,
                        col.names   = c("Sky condition",
                                        "Season",
                                        "Trend [\\%/year]",
                                        "Trend S.E. ($2\\sigma$)",
                                        "Pearson correl.",
                                        "Trend p-value" ),
                        # format.args = list(digits = 3),
                        linesep     = "",
                        align       = "ccrrrr",
                        centering   = FALSE,
                        table.envir = "table",
                        # position    = "H",
                        caption  = "SDR linear trends of monthly anomalies for each season of the year.")

# x_latex %>%
#     collapse_rows(columns = 1, valign = "middle", latex_hline = "custom") %>%
#     kable_styling(latex_options = c("striped",
#                                     "hold_position")
#     )

suppressMessages(
x_latex %>%
    collapse_rows(columns = 1, valign = "middle", latex_hline = "custom")           %>%
    kable_styling(latex_options = c('striped', 'hold_position'), full_width = TRUE) %>%
    column_spec(1, width = "8em")
)

```




# Conclusions

We have analyzed a 30 year dataset of SRD measurements in Thessaloniki Greece 
(`r paste(year(min(ALL_1_daily_DESEAS$Date)), " -- ", year(max(ALL_1_daily_DESEAS$Date)))`) aiming to identify the long term variability of
solar irradiance under different sky conditions.
Under all-sky conditions 
there is a positive trend in SDR of $`r alltrend`\,\%/y$ (brightening). 
A previous study [@Bais2013] for the period 1993 -- 2011 reported also a positive trend, of $0.33\,\%/y$.
The slight increase of this trend indicates that the brightening of SDR continues and is probably caused by continuing decreases in aerosol optical depth and the optical thickness of clouds over the area.
A smaller trend has
been found under clear-sky conditions ($`r cleartrend`\,\%/y$) which supports the
notion that part of the brightening is caused by decreasing aerosols.
@Siomos2020 have shown that aerosol optical depth over
Thessaloniki is decreasing constantly at least up to 2018.
Unfortunately, for this study aerosol data for the entire period were
not available in order to quantify their effect on SDR. The attenuation
of SDR by aerosols over Europe has been proposed as major factor by @Wild2021.
The brightening effect on SDR under cloudy-sky conditions
($`r cloudtrend`\,\%/y$), suggests that cloud optical thickness is also decreasing
during this period.
As long term data of cloud optical thickness are
also not available for the region, we cannot draw quantitative
conclusions.
@Lozano2023 reported a Cloud Radiative Forcing (CRF) SDR trend of $1.22\,W/m^2/y$ for the city of Granada Spain ($37^\circ\,10'\,$N, $3^\circ\,37'\,$E, $680\,$m\ a.s.l.). 
 <!-- (37.16◦ N, 3.61◦ W, 680 m a.s.l.), 37° 9' 35.9994" N  3° 36' 35.9994" W    ($37^\circ\,10'\,$N, $3^\circ\,37'\,$E, $680\,$m\ a.s.l.)-->
We found a comparable result, for the same parameter, using the long term trend of all- and clear-skies, as follows $\text{CRF} = 1.46 - 0.501 = `r 1.46 - 0.501`\,W/m^2/y$.

The observed brightening on SDR over Thessaloniki is dependent on SZA (larger SZAs lead to stronger brightening).
The trend is also dependent on season, with winter showing the strongest statistically significant trend of
$`r signif(spp$"Trend [%/year]"[spp$Season == "Winter" & spp$"Sky condition" == "All skies"], 2)`$
and
$`r signif(spp$"Trend [%/year]"[spp$Season == "Winter" & spp$"Sky condition" == "Cloudy skies"], 2)`\,\%/y$
for all- and cloudy-skies, respectively, in contrast to spring and summer.
The trends for autumn are also significant but smaller (
$`r signif(spp$"Trend [%/year]"[spp$Season == "Autumn" & spp$"Sky condition" == "All skies"], 2)`$
and
$`r signif(spp$"Trend [%/year]"[spp$Season == "Autumn" & spp$"Sky condition" == "Cloudy skies"], 2)`\,\%/y$
for all- and cloudy-skies, respectively).
Our findings are in agreement with other studies for the region.
The trend for clear skies is largest in winter
($`r signif(spp$"Trend [%/year]"[spp$Season == "Winter" & spp$"Sky condition" == "Clear skies"], 2)`\,\%/y$) 
and negligible in spring, summer and autumn.

Using the CUSUMs of the monthly departures for all- and cloudy-skies, we observed a 20 year period starting around 2000 where the CUSUMs remain relatively stable, with a steep decline before and a steep increase after. 
The rather smooth course of the CUSUMs suggests that no important
change in the SDR pattern has occurred in the entire record.

Continued observations with a collocated pyrheliometer, which started in 2016, will allow us to further investigate the variability of solar radiation at ground level in Thessaloniki. 
Also, additional data of cloudiness, aerosols, atmospheric water vapour, etc., will allow better attribution and quantification of the effects of these factors on SRD.

<!--
similar results with Evidence for Clear‐Sky Dimming and Brightening in Central Europe_Wild2021.pdf
include in discussion
-->


