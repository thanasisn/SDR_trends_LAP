---
title:         "Trends of SDR in Thessaloniki"
# header-includes:
author:
  - name:         Athanasios Natsis 
    email:        natsisphysicist@gmail.com
    affiliation:  Laboratory of Atmospheric Physics
#    footnote:     1
    correspondingauthor: true
  - name:         Alkiviadis Bais
    email:        abais@auth.gr 
    affiliation:  Laboratory of Atmospheric Physics
    correspondingauthor: false
address:
  - code:         Laboratory of Atmospheric Physics
    organization: Aristotle University of Thessaloniki
    addressline:  Campus Box 149
    city:         Thessaloniki
    # state:        State
    postcode:     54124
    country:      Greece
#  - code:         Another University
#    organization: Department
#    addressline:  A street 29
#    postcode:     2054 NX
#    city:         Manchester,
#    country:      The Netherlands
# footnote:
#   - code:         1
#     text:         "This is the first author footnote."
#   - code:         2
#     text:         "Another author footnote."
abstract: |
  Study of GHI and DNI radiation for 'clear-sky' and all-sky conditions.
  It consists of two paragraphs.
keywords: 
  - GHI
  - SDR
  - Solar Brigthening/Dimming
journal:         "An awesome journal"
date:            "`r Sys.Date()`"
classoption:     preprint, 3p, authoryear
bibliography:    Mainreferences.bib
linenumbers:     false
numbersections:  true
header-includes:
   # - \usepackage{subfig}
   - \usepackage{subcaption}
output: 
  bookdown::pdf_document2:
    number_sections:  no
    fig_caption:      yes
    keep_tex:         no
    latex_engine:     xelatex
    toc:              no
    toc_depth:        4
    fig_width:        7
    fig_height:       4.5
    documentclass:    article
    classoption:      a4paper,oneside
    fontsize:         12pt
    geometry:         "left=0.75in,right=0.75in,top=0.75in,bottom=0.75in"
    link-citations:   yes
    colorlinks:       yes
    urlcolor:         blue
    biblio-style:     apalike
  bookdown::word_document2: default
  rticles::elsevier_article:
    keep_tex:         no
    citation_package: natbib
# date:           "`r format(Sys.time(), '%F')`"
---



```{r echo=F, include=T, warning=FALSE, message=FALSE}
suppressMessages(
    res <- rmarkdown::find_pandoc(dir = '/usr/lib/rstudio/resources/app/bin/quarto/bin/tools')
)
## document configurations 
knitr::opts_chunk$set(comment    = ""      )
# knitr::opts_chunk$set(dev        = "pdf"   )
knitr::opts_chunk$set(out.width  = "70%"   )
knitr::opts_chunk$set(fig.align  = "center")
knitr::opts_chunk$set(fig.pos    = 'h!'    )
options(knitr.graphics.auto_pdf = FALSE)
library(pander)
library(data.table)
## load data from trends analysis
load("./data/common_data_14_2.Rda")
## number of measurements for each dataset
SDR_N_All   <- sum(  ALL_1_daily_DESEAS[,GLB_att_N])
SDR_N_Clear <- sum(CLEAR_1_daily_DESEAS[,GLB_att_N])
SDR_N_Cloud <- sum(CLOUD_1_daily_DESEAS[,GLB_att_N])
## TSI data span info
TSIinfo <- data.table(read.csv("./figures/tbl_tsi_info.dat",
                    strip.white = TRUE,
                    sep = ";",
                    header = TRUE))
## variables we use in the analysis
source("./DHI_GHI_0_variables.R")

## create local citations file and links here
source("~/CODE/FUNCTIONS/R/gather_citations.R")
suppressMessages(
    gather_citations(
        sourcefile   = "./Article.Rmd",
        mainreposit  = "./Mainreferences.bib",
        localreposit = "./references.bib",
        folderlink   = "./References_links",
        workingdir   = "./"
    )
)
```

<!-- use SDR for GHI -->

# Introduction.

<!-- something about aerosols: bais mail -->
<!-- something about clouds: bais mail -->
<!--
Η εισαγωγή είναι εντάξει. Ίσως θα μπορούσες να βάλεις στη 2η
παράγραφο ακόμη 2-3 σειρές για τις τάσεις του αεροζόλ και των νεφών
από τις εργασίες και να καταλήξεις με κάποια στοιχεία για το αεροζόλ
στη Θεσσαλονίκη από εργασίες δικές μας. Για τα νέφη δεν έχω υπόψη μου
καμία εργασία αλλά ίσως θα μπορούσε να ειπωθεί κάτι χρησιμοποιώντας
παγκόσμιες εκτιμήσεις για την περιοχή της Μεσογείου.
π.χ. https://link.springer.com/article/10.1007/s00382-022-06438-3
-->
....

more about trend in relation to other trends
Aerosols and clouds

......

The shortwave downward solar irradiance (SDR) at Earth's surface play a significant role, on its climate.
Changes of the SDR can be related to changes on Earth's energy budget, the mechanisms of climate change, and water and carbon cycle [@Wild2009].
Can also affect, solar and agricultural production, and living organisms.
Studies of SDR variability, have identified some distinct SDR trends on different regions of the world and for different time periods.
The term 'brightening' is generally used to describe periods of positive SDR trend, and 'dimming' for negative trend.
There are many cases on the long term records of irradiance, showing a systematic change of SDR's trend slope, occurring roughly at the last decades of the 20th century.
<!-- Trends china -->
On multiple station in China, a dimming period was reported until about 2000, followed by a brightening period [@Yang2021]. 
<!-- Trends Europe Brazil -->
A similar pattern was identified, with the breaking point around 1980, for stations in Central Europe [@Wild2021] and Brazil [@Yamasoe2021].
<!-- Trends Global -->
Also, on global scale, an AI aided continental level spatial analysis, with data from multiple station, reach similar conclusions for the above regions and for the global trend [@Yuan2021].

There is a consensus, among researchers, that major factors of SDR attenuation is the interaction with atmospheric aerosols and clouds. 
Those interactions, among other factors, have been analysed with models [@Li2016; @Samset2018], showing the existence of feedback mechanisms between the two.
Similar finds, have been showed in observational data [@Schwarz2020; @Ohvril2009; @Zerefos2009; @Xia2007 and references therein].
<!-- Sun variability: should cite that there is no significant trend found Wild2021 -->

Due to the variability of the phenomenon, and its contributing factors, there is a need to further investigate and monitor SDR, in different sites, to estimate its magnitude, and its relation to the local conditions.
In this study, we examine the trends of SDR, with ground-based measurements at Thessaloniki, Greece for the period `r year(min(ALL_1_daily_DESEAS$Date))` to `r year(max(ALL_1_daily_DESEAS$Date))`, as derived from a CM-21 pyranometer.
<!-- goals -->
We reevaluated and extended the dataset used by @Bais2013, applying a different algorithm for the identification of clear-/cloud-sky instances [@Reno2016; @Reno2012a], and we derive the radiation trends for the period `r year(min(ALL_1_daily_DESEAS$Date))` to `r year(max(ALL_1_daily_DESEAS$Date))`, under different sky conditions (all-sky, clear-sky and cloud-sky).


<!--
Aerosols interactions

#Yang2021  Cloud “shrinking” and “optical thinning” in the “dimming” period and a subsequent recovery in the “brightening” period over China

Aerosols not only strengthen but also weaken the
growth of clouds with respect to their coverage and
optical thickness, depending on the levels of pollution
and the associated amounts of aerosols as postulated
in a conceptual framework (Wild 2009a, 2012, Yang
et al 2012). 


...... cloud formation occurrences and constitution nuclei. cite .....
p>        "  Too hard to vim


#Wild2012 : simplify interaction nice graph

-->

# Observational data and methodology.

The SDR data were measured with a Kipp & Zonen CM-21 pyranometer operating continuously at the Laboratory of Atmospheric Physics of the Aristotle University of Thessaloniki 
($40^\circ\,38'\,$N, $22^\circ\,57'\,$E, $80\,$m\ a.s.l.)
in the period from 
<!-- \mbox{ -->
`r min(ALL_1_daily_DESEAS$Date)`
<!-- } -->
to
<!-- \mbox{ -->
`r max(ALL_1_daily_DESEAS$Date)`.
<!-- }. -->
The monitoring site is located near the city centre, and we expect to be affected by the urban environment. 
During the study period, the pyranometer has been independently calibrated three times at the Meteorologisches Observatorium Lindenberg, DWD, when it was verified the stability of the instrument to within better than $0.7\%$ relative to the initial calibration by the manufacturer. 
Along with SDR, the direct beam radiation (DNI) was also measured by a collocated Kipp & Zonen CHP-1 pyrheliometer, for the period
<!-- \mbox{ -->
`r min(ALL_1_daily_DESEAS[!is.na(DIR_att), Date])`
<!-- } -->
to
<!-- \mbox{ -->
`r max(ALL_1_daily_DESEAS[!is.na(DIR_att), Date])`.
<!-- }. -->
Although, we have performed a similar analysis to the DNI data the results are not presented here, as they lack the appropriate statistical significance, due to the sorter duration of the data. 
However, the DNI data were used as auxiliary data, in the clear sky identification algorithm (CSid), which is discussed later, for the selection of the appropriate thresholds.
It is noted that despite the capability of the CSid algorithm to use the DNI as a characterization parameter, we haven't used it here, to avoid any selection bias due to unequal length of the two datasets. 
There are three distinct steps in the creation of the dataset analysed here:
a)\ the acquisition of radiation measurements from the sensors,
b)\ the data quality check,
c)\ the identification of "clear sky" conditions from the radiometric data, and d)\ the aggregation of data and trend analysis.


<!--
The horizon is clear of obstructions except for the azimuth angles between 35 and 120 where obstacles of up to 10 elevation block the direct irradiance in the morning for SZA larger than 80.  These data points were excluded from the analysis, as
-->

<!-- Zerefos 
Northern Greece has been selected because it is well known to be located at the crossroads of aerosols and various pollutants pathways originating in central and Eastern
Europe (Lelieveld et al., 2002; Zerefos et al., 2002). Thessa-
loniki, the major city in northern Greece, lies along the exit of air
pollutants from Europe, in the path of the prevailing long-range
transport (LRT) trajectories, as we move from central and east-
ern Europe to the Mediterranean (Zerefos et. al., 2002). On the
-->

<!-- a) acquisition -->
For the acquisition of radiometric data, the signal of the pyranometer is sampled with a rate of $1\,\text{Hz}$.
The mean and the standard deviation of these samples are recorded every minute.
The measurements are corrected for the zero offset (dark signal in volts).
The "dark signal" is calculated by averaging all measurements recorded for a period of 
$3\,\text{h}$ 
before (morning) or after (evening), when the Sun reaches an elevation angle of
$-10^\circ$.
The signal is converted to irradiance using a ramped value of the instrument’s sensitivity between the calibrations.

<!-- b) Radiation data quality check -->
A manual screening was performed, to remove inconsistent and erroneous recordings that can occur stochastically or systematically, during the continuous operation of the instruments.
The manual screening is aided by a radiation data quality assurance procedure, adjusted for the site, which is based on the methods of 
Long and Shi\ [-@Long2008a; -@Long2006].
Thus, problematic recordings have been excluded from further processing. 
Although it is impossible to detect all false data, the large number of available data, and the aggregation scheme we used, ensures the good quality of the radiometric measurements used in this study.

<!-- c) Clear sky identification -->
In order to be able to estimate the effect of the clouds on the long term variability of SDR, we created three datasets, by characterizing each one-minute measurement with a corresponding sky condition (i.e., all-sky, clear-sky and cloudy-sky).
To identify the clear-sky conditions we used the method proposed by
@Long2000
and by
@Reno2016,
which was adapted and configured for the site, as the authors suggest.

<!-- CS subjectivity -->
We have to note, that the definition of what constitutes as clear or cloudy sky, has some subjectivity, in this method of characterization.
As a result, the details of the definition is site specific, it relies on a combination of thresholds and comparisons with ideal actinometric models and statistical analysis on different signal metrics.
The CSid algorithm was calibrated with the main focus to identify the presence of clouds on the sky dome, although few marginal cases exist that have been identified as false positive or false negative, but cannot affect the results of the study.


```{r setup, echo=F, include=T, eval=TRUE}
## Load Clear Sky id v14.2 variables
MS <- data.frame(readRDS("~/CS_id/PARAMS/Clear_sky_id_Reno-Hansen_apply_v14_2.Rds"))
# export all Clear Sky variables
for (an in names(MS)) {
assign(an, MS[[an]])
}
## get TSI slope for reference
TSI <- data.table(read.csv("./figures/tbl_longterm_trends.dat",
           strip.white = TRUE,
           sep = ";",
           header = TRUE))
TSI <- TSI[grep("TSI", TSI$var), ]
TSI$slope.sd           <- NULL
TSI$slope.ConfInt_0.95 <- NULL
TSI$slope.ConfInt_0.99 <- NULL
TSI$var                <- NULL
setorder(TSI, -slope.stat_sig)
rownames(TSI) <- NULL
names(TSI) <- c("Trend [%/year]", "Trend p-value", "Sky condition", "Trend statistical signif. [%]")
TSIslopeAll <- TSI[`Sky condition` == "All sky cond."]
```

<!-- # Detection of clear periods in GHI measurements for SDR trends. -->

For completeness, we will provide below a brief overview of the [....Csid
term is referenced above....]{.comment-start id="0" author="A N"
date="2023-07-15T20:00:52Z"}CSid algorithm[]{.comment-end id="0"}, along
with the site specific thresholds.
To calculate the reference clear sky
$\text{SDR}_\text{CSref}$ we used the [....Not visible equation....]{.comment-start id="2"
author="A N" date="2023-07-15T19:23:34Z"}${}_{}$[[]{.comment-end
id="2"}]{.insertion author="A N" date="2023-07-15T19:23:34Z"} derive by
the radiation model of @Haurwitz1945, adjusted for our site with a
factor $a$, resulted by an iterative optimization process, as described
by @Long2000 and @Reno2016.
The target of
the optimization was the minimization of the function $f(a)$ (Eq.\ \ref{eq:minf}) and
was accomplished with the computing function [\...notation
"library::function"....]{.comment-start id="2" author="A N"
date="2023-07-15T20:08:20Z"}"stats::optimise"[]{.comment-end id="2"}
of the R language [@RCT2023], with an implementation based on the work of @Brent1973. 
The optimization and the selection of the clear sky reference model, was performed on SDR observations for the period 2016 - 2021.
During the optimization, eight simple clear sky radiation models were tested (Daneshyar-Paltridge-Proctor, Kasten-Czeplak, Haurwitz, Berger-Duffie, Adnot-Bourges-Campana-Gicquel, Robledo-Soler, Kasten and Ineichen-Perez), with a wide range of factors.
These models are described in more details by @Reno2012 and evaluated by @Reno2016.
We found, that Haurwitz's model, adjusted with the factor $a = `r signif(alpha,3)`$ yields one of the lowest root mean squared errors (RMSE), [....rephrased....]{.comment-start id="3" author="A N" date="2023-07-15T20:32:50Z"}while the procedure, manages to characterize the majority of our data[]{.comment-end id="3"}. Thus, our clear sky reference is derived by the Eq.\ \ref{eq:ahau}.


<!-- cost fuction -->
\begin{equation}
f(a) = \frac{1}{n}\sum_{i=1}^{n} ( \text{SDR}_{\text{CSid},i} - a \times \text{SDR}_{\text{testCSref},i} )^2 \label{eq:minf}
\end{equation}

where: $n$ is the total number of daylight records, $\text{SDR}_{\text{CSid},i}$ are the records identified as clear sky by CSid, $a$ is a hypothetical adjustment factor, and $\text{SDR}_{\text{testCSref},i}$ is any of the tested clear sky radiation models.


<!-- adjusted Haurwitz -->
\begin{equation}
\text{SDR}_\text{CSref} = a \times \text{SDR}_\text{Haurwitz}  = `r signif(alpha,3)` \times 1098 \times \cos( \text{SZA} ) \times \exp \left( \frac{ - 0.057}{\cos(\text{SZA})} \right) \label{eq:ahau}
\end{equation}

where: $\text{SDR}_\text{CSref}$ is the reference clear sky SDR, in $\text{w}\,\text{m}^{-2}$.


The criteria that were used to identify whether a measurement was taken
under clear-sky conditions are presented below.
A data point is flagged
as "clear-sky" if all criteria are satisfied.
Each criterion was applied
for a running window of $`r nt`$ consecutive one-minute measurements, and
the characterization is assigned to the central value of the window.
Each parameter was calculated both from the measurements and the
clear-sky model.
The allowable range of variation is defined by the
model-derived value of the parameter multiplied by a factor plus an
offset. [.... .expanded the description ....]{.comment-start id="4"
author="A N" date="2023-07-15T22:48:13Z"}The factors and offsets were
determined empirically, by manual inspecting each filters performance on
selected days, and adjusting them accordingly, during the iterative
process.[[]{.comment-end id="4"}]{.insertion author="A N"
date="2023-07-15T22:48:13Z"}


<!-- 1. MeanVIP -->
<!-- ### Mean value of irradiance during the time period. -->

<!--a) Mean of the measured $\overline{\text{SDR}}_i$ = \text{mean}_{n=i-5}^{n=i+5}[\text{SDR}_{n}]$ and running mean of the reference $\overline{\text{SDR}}_{\text{CSref},i}$ = \text{mean}_{n=i-5}^{n=i+5}[\text{SDR}_{\text{CSref},n}]$ (Eq. \ref{eq:MeanVIP}).-->

a) Mean of the measured $\overline{\text{SDR}}_i$ (Eq. \ref{eq:MeanVIP}).
\begin{equation}
`r 1 - CS_ref_rm_VIP_RelLow` \times \overline{\text{SDR}}_{\text{CSref},i} - `r CS_ref_rm_VIP_LowOff`
< \overline{SDR}_i <
`r 1 + CS_ref_rm_VIP_RelUpp` \times \overline{\text{SDR}}_{\text{CSref},i} + `r CS_ref_rm_VIP_UppOff`
\label{eq:MeanVIP}
\end{equation}


<!-- 2. MaxVIP -->
<!-- ### Max value of irradiance during the time period. -->

<!-- The running max measured value $M_{\text{SDR},i} = \max_{n=i-5}^{n=i+5}[\text{SDR}_{n}]$, is compared to a similar constructed value from the reference $M_{CSrefi} = \max_{n=i-5}^{n=i+5}[\text{SDR}_{\text{CSref},n}]$ (Eq.\ \ref{eq:MaxVIP}). -->

b) Maximum measured value $M_{\text{}}$ (Eq.\ \ref{eq:MaxVIP}).
\begin{equation}
`r MaxVIP_fct` \times M_{\text{CSref},i} - `r MaxVIP_off_low`
< M_{\text{}i} <
`r MaxVIP_fct` \times {\text{CSref},i} + `r MaxVIP_off_upp`
\label{eq:MaxVIP}
\end{equation}

<!-- 3. VIL -->
<!-- ### Variability in irradiance by line length. -->
c) Length $L_i$ of the sequential line segments, connecting the points of the $`r nt`$ SDR values (Eq. \ref{eq:VILeq}).
\begin{equation}
L_i = \sum_{i=1}^{n-1}\sqrt{\left ( \text{SDR}_{i+1} - \text{SDR}_{i}\right )^2 + \left ( t_{i+1} - t_i \right )^2}
\label{eq:VILeq}
\end{equation}
\begin{equation}
`r MinVIL_fct` \times L_{\text{CSref},i} - `r offVIL_dwl` < L_i < `r MaxVIL_fct` L_{\text{CSref},i} + `r offVIL_upl`
\label{eq:VILcr}
\end{equation}
where: $t_i$ is the time each SDR measurement has been measured

<!-- 4. VCT -->
<!-- ### Variance of Changes in the Time series. -->

<!-- Standard deviation of rate of change in irradiance. -->
d) Standard deviation $\sigma_i$ of the slope ($s_i$) between the $`r nt`$ sequential points, normalized by the mean $\overline{\text{SDR}}_i$ (Eq.\ \ref{eq:VCT1}).
<!-- \begin{gather}
\bar{s} = \frac{1}{n-1} \sum_{i=1}^{n-1} s_i \label{eq:VCT2} \\
\sigma_i = \frac {\sqrt{\frac{1}{n-1} \sum_{i=1}^{n-1} \left( s_i - \bar{s} \right)^2} } {\bar{G_i}} \label{eq:VCT3}
\end{gather} -->
\begin{gather}
  \sigma_i = \frac {\sqrt{\frac{1}{n-1} \sum_{i=1}^{n-1} \left( s_i - \bar{s} \right)^2}} {\overline{\text{SDR}}_i} \label{eq:VCT1} \\
  s_i = \frac{\text{SDR}_{i+1} - \text{SDR}_{i}}{t_{i+1} - t_i},\;\;   \bar{s} = \frac{1}{n-1} \sum_{i=1}^{n-1} s_i,\;\;\forall i \in \left \{ 1, 2, \ldots, n-1 \right \}\;\;
\end{gather}
For this criterion, $\sigma_i$ should be below a certain threshold (Eq.\ \ref{eq:VCTcr}):
\begin{equation}
  \sigma_i < `r offVCT` \label{eq:VCTcr}
\end{equation}

<!-- 5. VSM -->
<!-- ### Variability in the Shape of the irradiance Measurements. -->

e) Maximum difference $X_i$ between the change in measured irradiance and the change in clear sky irradiance over each measurement interval.
\begin{gather}
  X_i = \max{\left \{ \left | x_i - x_{\text{CSref},i} \right | \right \}} \label{eq:VSM3} \\
  x_i = \text{SDR}_{i+1} - \text{SDR}_{i} \forall i \in \left \{ 1, 2, \ldots, n-1 \right \} \label{eq:VSM1} \\
  x_{\text{CSref},i} = \text{SDR}_{\text{CSref},i+1} - \text{SDR}_{\text{CSref},i} \forall i \in \left \{ 1, 2, \ldots, n-1 \right \} \label{eq:VSM2}
\end{gather}
For this criterion, $X_i$ should be below a certain threshold (Eq.\ \ref{eq:VSMcr}):
\begin{equation}
  X_i < `r offVSM` \label{eq:VSMcr}
\end{equation}


<!-- ### Data selection -->
Due to a significant measurement uncertainty near the horizon, we have to exclude all measurements with SZA greater than $`r 90-MIN_ELEVA`^\circ$. 
Moreover, due to some obstructions around the site (hills and buildings), we excluded data with Azimuth angle between 
$35^\circ$ and $120^\circ$ with SZA greater than $80^\circ$.
On the latter instances, Sun is systematically, not visible by the instrument's location.
<!-- 1au -->
To make the measurements comparable throughout the dataset, we adjusted all one-minute radiometric values to the mean Sun - Earth distance.
<!-- TSI -->
Subsequently, we made all measurements relative to the Total Solar Irradiance (TSI) at $1\,\text{au}$, in order to compensate for the Sun's intensity variability, using a homogenized time series of satellite TSI observations.
The TSI data we use are part of the "NOAA Climate Data Record of Total Solar Irradiance" dataset [@Coddington2005].Where the initial daily values, were interpolated to match with the time step of our measurements. 
The final dataset contains
$`r SDR_N_All`$
one-minute measurements, of which, 
$`r signif(100 * SDR_N_Clear / SDR_N_All, 3)`\%$
were identified as under clear-sky conditions and subsequently
$`r signif(100 * SDR_N_Cloud / SDR_N_All, 3)`\%$
as under cloud-sky conditions.
<!-- The TSI data we use, is a combination of data from NOAA [@Coddington2005] (for `r as.Date(TSIinfo[TSI_Source == "NOAA", Start])` - `r as.Date(TSIinfo[TSI_Source == "NOAA", End])`) and adjusted data from @LASP2023 (for `r as.Date(TSIinfo[TSI_Source != "NOAA", Start])` - `r as.Date(TSIinfo[TSI_Source != "NOAA", End])`).-->

<!-- aggregation -->
In order to investigate the SDR trends, we implemented an appropriate aggregation scheme to the 1-minute data to derive series in coarser time scales.
To preserve the representativeness of the data we used the following criteria: 
<!-- a) for daily mean values we exclude days with less than `r Daily_aggregation_N_lim` valid data points, -->
a) for the daily mean values we accept days with more than `r 100 * All_daily_ratio_lim`% of the daytime measurements, present and valid,
b) monthly values were computed from daily means
only when at least `r Monthly_aggegation_N_lim` days were available.
To create the daily and monthly climatological means, we averaged the data based on the day of year and calendar month, respectively.
<!-- Seasonal -->
For the seasonal means we averaged the mean daily values in each season (Winter: December - February, Spring: March - May, etc.).
<!-- Deseasonalization -->
Finally, each data set was deseasonalized by subtracting the corresponding climatological annual cycle (daily or monthly) from the actual data.
To estimate SZA contribution to the SDR trends, the one-minute data were aggregated in $1^\circ$ SZA bins, separately for the morning and afternoon hours, and then were deseasonalized as mentioned above.




# Results

## Long-term SDR trends

We calculated the SDR trends, from the mean daily values of the departure from the seasonal values, for the whole time series for the three sky conditions (Table\ \ref{tab:trendtable}).
We present only the plot for the trend under all-sky conditions (Figure\ \ref{fig:trendALL}), as the plots for clear-sky condition and cloud-sky condition, are very similar.
In the studied time period, there is no significant break or change in the variability of the overall trends.
Other studies for the European region are reporting a change of the SDR slope, around the 1980, few years before the start of our records [@Wild2021; @Yuan2021; @Ohmura2009]. It is interesting to note, that for the observation period, the trend of the TSI is
$`r format(TSIslopeAll[1,1], scientific = T, digits = 2)`\%/year$.

<!-- \footnotesize -->
```{r trendtable, echo=F}
LT <- data.table(read.csv("./figures/tbl_longterm_trends.dat",
               strip.white = TRUE,
               sep = ";",
               header = TRUE))
LT <- LT[grep("SDR", LT$var), ]
LT$slope.sd           <- NULL
LT$slope.ConfInt_0.95 <- NULL
LT$slope.ConfInt_0.99 <- NULL
LT$var                <- NULL
setorder(LT, -slope.stat_sig)
rownames(LT) <- NULL
names(LT)    <- c("Trend [%/year]", "Trend p-value", "Sky condition", "Trend statistical signif. [%]")
## no need all are 100%
LT$`Trend statistical signif. [%]` <- NULL
## numeric presision
LT$`Trend [%/year]` <- signif(LT$`Trend [%/year]`, 3)
LT$`Trend p-value`  <- signif(LT$`Trend p-value`,  3)

panderOptions("table.alignment.default", "center")
pander(LT,
       caption = paste0("\\label{tab:trendtable}Trends of daily SDR means, for different sky conditions for ", year(min(ALL_1_daily_DESEAS$Date)), " - ", year(max(ALL_1_daily_DESEAS$Date)), ". For all cases the statistical significance is above $99.9\\%$."))
# knitr::kable(LT, caption = "Trends of daily means by sky conditions.")
## some vars to use later
alltrend   <- signif(LT[`Sky condition` == "All sky cond.",   `Trend [%/year]`], 2)
cleartrend <- signif(LT[`Sky condition` == "Clear sky cond.", `Trend [%/year]`], 2)
cloudtrend <- signif(LT[`Sky condition` == "Cloudy cond.",    `Trend [%/year]`], 2)
```
<!-- \normalsize -->


```{r trendALL, echo=F, out.width='.70\\linewidth', fig.cap=paste0("Anomaly (\\%) of the daily SDR relative to climatological values for ", year(min(ALL_1_daily_DESEAS$Date)), " - ", year(max(ALL_1_daily_DESEAS$Date)), ". The black line shows the long term trend for all-sky conditions.")}
knitr::include_graphics("./images/LongtermTrends-2.png")
```


Although, using the cumulative sums plots we can reveal some structure within the trends and some difference between the sky conditions [@Regier2019]. 
On all three plots on Figure\ \ref{fig:cumsum}, we observe a step downward part at the start of the period until about 2000, an almost steady part until about 2016 for All-sky and Clear-sky conditions (Figures\ \ref{fig:cumsum-1}, \ref{fig:cumsum-2}), and until 2009 for Cloud-sky conditions (Figure\ \ref{fig:cumsum-3}), and finally, a steep upward part until the present.
For a uniform trend, we expected the cumulative sum plot of the anomaly to have a symmetric 'V' shape.
This would indicate, that the anomaly is evenly distributed around the climatological mean.
In our case, for all sky conditions we observe periods where the cumulative sum remains relative steady, roughly in the middle of the study dataset.
Another distinct feature of the cumulative plots, is the difference, between the Cloud-sky and the rest of the sky conditions, where they display an supplementary behavior. 

<!--
This can make us to suspected that clear-Sky conditions SDR and cloud-sky SDR is affected by different mechanisms.
The similarity of the All-sky and Clear-sky conditions, can make us to suspected that on both sky conditions the attenuation of SDR has .
-->

```{r cumsum, echo = FALSE, fig.cap='Running cumulative sum plots of the daily SDR for three different sky conditions', fig.subcap=c('All-sky conditions', 'Clear-sky conditions', 'Cloud-sky conditions'), out.width='.32\\linewidth', fig.asp=1, fig.ncol = 3}
knitr::include_graphics(c(
    "./images/CumulativeDailyCumSum-1.png",    # ALL sky
    "./images/CumulativeDailyCumSum-5.png",    # CLEAR sky
    "./images/CumulativeDailyCumSum-9.png"))   # Cloud sky
```

<!-- ```{r cumsumSTD, echo = FALSE, fig.cap='two plots', fig.subcap=c('one plot', 'the other one'), out.width='.32\\linewidth', fig.asp=1, fig.ncol = 3} -->
<!-- knitr::include_graphics(c( -->
<!--     "./images/CumulativeDailyCumSumSTD-1.png",    # ALL sky -->
<!--     "./images/CumulativeDailyCumSumSTD-2.png",    # CLEAR sky -->
<!--     "./images/CumulativeDailyCumSumSTD-3.png"))   # Cloud sky -->
<!-- ``` -->




....

more about trend in relation to other trends
Aerosols and clouds

......



<!-- ```{r trendCLEAR, echo=F, fig.cap="Daily SDR seasonal anomaly and long term trend, for clear sky conditions."} -->
<!-- knitr::include_graphics("./images/LongtermTrends-4.png") -->
<!-- ``` -->

<!-- ```{r trendCLOUD, echo=F, fig.cap="Anomaly (\\%) of the daily SDR relative to climatological values for 1993 - 2023. The black line shows the long term trend for cloud-sky conditions."} -->
<!-- knitr::include_graphics("./images/LongtermTrends-6.png") -->
<!-- ``` -->




## Effects of the solar zenith angle on SDR.

The relative position of the Sun in the sky, is a major drive of the attenuation of SDR reaching the ground, as it is affected by the radiation path in the atmosphere and possible human activities in urban environment emitting aerosols [@Wang2021].
In order to estimate the contribution of the SZA, we group the anomaly data in $1^\circ$ SZA bins, and calculated the overall trend for each bin before noon and after noon (Figure\ \ref{fig:szatrends}).
Although there is a seasonal change of SZA limits than is not represented here, the brightening effect of SDR is stronger for All-sky and Clear-sky condition for low Sun elevation angles (Figures\ \ref{fig:szatrends}a and \ref{fig:szatrends}b).
In the case of Cloud-sky condition (Figure\ \ref{fig:szatrends}c), there is no strong correlation between SDR brightening and SZA, except for some low Sun angles, that occur only for a small part of the year, and thus we can not draw more conclusions from this analysis for the over trend.

```{r szatrends, echo = FALSE, fig.cap='Distribution of the SDR\'s long term trends by SZA before and after noon. The solid data points represent values with an acceptable statistical significance ($p<0.005$).', fig.subcap=c('All-sky conditions.', 'Clear-sky conditions.', 'Cloud-sky conditions.'), out.width='.35\\linewidth', out.width='.32\\linewidth', fig.asp=1, fig.ncol = 3}
knitr::include_graphics("./images/SzaTrends-13.png")
knitr::include_graphics("./images/SzaTrends-17.png" )
knitr::include_graphics("./images/SzaTrends-21.png")
```



## Long term trends by season of year


Similar to the long term trends discussed above, we have produced the deseasonalized trend for the different sky conditions, for each season of the year, using the corresponding mean monthly values.

This can give us a better understanding of the annual cycle of the trends.

```{r seasonalALL, echo=F, fig.cap="Trends by season for all condition. Displaying monthly means of daily means.", out.width="100%"}
knitr::include_graphics("./images/SeasonalTrendsTogether-1.png")
```


<!-- ```{r seasonalALL, echo=F, fig.cap="Trends by season for All-sky condition. Displays monthly means of daily means."} -->
<!-- knitr::include_graphics("./images/SeasonalTrends-1.png") -->
<!-- ``` -->

<!-- ```{r seasonalCLEAR, echo=F, fig.cap="Trends by season for Clear-sky condition. Displays monthly means of daily means."} -->
<!-- knitr::include_graphics("./images/SeasonalTrends-2.png") -->
<!-- ``` -->

<!-- ```{r seasonalCLOUD, echo=F, fig.cap="Trends by season for Cloudy-sky condition. Displays monthly means of daily means."} -->
<!-- knitr::include_graphics("./images/SeasonalTrends-3.png") -->
<!-- ``` -->




<!-- \footnotesize -->
```{r trendseasontable, echo=F}
pp <- read.csv("./figures/tbl_longterm_trends_season.dat",
               strip.white = TRUE,
               sep = ";",
               header = TRUE)
pp <- pp[grep("SDR" ,pp$var), ]
pp$slope.sd           <- NULL
pp$slope.ConfInt_0.95 <- NULL
pp$slope.ConfInt_0.99 <- NULL
pp$var                <- NULL
rownames(pp)          <- NULL
names(pp) <- c("Trend [%/year]", "Trend p-value", "Sky condition", "Season", "Trend statistical signif. [%]")
## order by season
target    <- c("Winter", "Spring", "Summer", "Autumn")
new_order <- sapply(target, function(x,pp){which(pp$Season == x)}, pp=pp)
pp        <- pp[new_order,]
## numeric precision
pp$`Trend [%/year]` <- signif(pp$`Trend [%/year]`, 3)
pp$`Trend p-value`  <- signif(pp$`Trend p-value`,  3)

rownames(pp) <- NULL

# panderOptions("table.alignment.default", "left")
panderOptions("table.alignment.default", "center")
pander(pp,
       caption = "\\label{tab:trendseasontable}SDR trends of monthly anomaly for each season of the year. The vertical scale is common for all subplots, for easier comparison.")
```
<!-- \normalsize -->


<!--
## Consistency of the trends

A method to evaluate changes in the long term trend is to use the cumulative sum of the variable.

Figure\ \ref{fig:cumsum}

... different in aggregation ...
-->

<!--
```{r cumsumALL, echo=F, fig.cap="Running cumulative sum."}
knitr::include_graphics("./images/CumulativeDailyCumSum-1.png")
```
-->

<!--
Not showing this trend
```{r cumsumCLEAR, echo=F, fig.cap="Donditions.", include=FALSE}
knitr::include_graphics("./images/CumulativeDailyCumSum-5.png")
```
-->

<!--
```{r cumsumCLOUD, echo=F, fig.cap="Donditions."}
knitr::include_graphics("./images/CumulativeDailyCumSum-9.png")
```
-->





# Conclusions

Our result for all-sky condition ($`r alltrend`\%/year$), reaffirm the previous results of @Bais2013 for the site.
The increase of this trend, shows that the phenomenon and probably the causes have been amplified.

.....
Also, the trend of $`r cloudtrend`\%/year$ for cloud-sky condition indicate the major part that clouds play on the
.....

.......

 
About:

- long terms trends
- seasonal trends
- effect of SZA
- effect of clouds

- Aerosols


similar results with Evidence for Clear‐Sky Dimming and Brightening in Central Europe_Wild2021.pdf
include in discussion




-------------------------------------------------
                   **END**
-------------------------------------------------
\newpage
