---
title:         "Trends of SDR in Thessaloniki"
# header-includes:
author:
  - name:         Natsis Athanasios
    email:        natsisphysicist@gmail.com
    affiliation:  Laboratory of Atmospheric Physics
#    footnote:     1
    correspondingauthor: true
  - name:         Alkiviadis Bais
    email:        abais@auth.gr 
    affiliation:  Laboratory of Atmospheric Physics
    correspondingauthor: false
address:
  - code:         Laboratory of Atmospheric Physics
    organization: Aristotle University of Thessaloniki
    addressline:  Campus Box 149
    city:         Thessaloniki
    # state:        State
    postcode:     54124
    country:      Greece
#  - code:         Another University
#    organization: Department
#    addressline:  A street 29
#    postcode:     2054 NX
#    city:         Manchester,
#    country:      The Netherlands
# footnote:
#   - code:         1
#     text:         "This is the first author footnote."
#   - code:         2
#     text:         "Another author footnote."
abstract: |
  Study of GHI and DNI radiation for 'clear-sky' and all-sky conditions.
  It consists of two paragraphs.
keywords: 
  - GHI
  - SDR
  - Solar Brigthening/Dimming
journal:         "An awesome journal"
date:            "`r Sys.Date()`"
classoption:     preprint, 3p, authoryear
bibliography:    Mainreferences.bib
linenumbers:     false
numbersections:  true
header-includes:
   # - \usepackage{subfig}
   - \usepackage{subcaption}
   
   
output: 
  rticles::elsevier_article:
    keep_tex:         no
    citation_package: natbib
  bookdown::pdf_document2:
    number_sections:  no
    fig_caption:      yes
    keep_tex:         no
    latex_engine:     xelatex
    toc:              no
    toc_depth:        4
    fig_width:        7
    fig_height:       4.5
    documentclass:    article
    classoption:      a4paper,oneside
    fontsize:         12pt
    geometry:         "left=0.75in,right=0.75in,top=0.75in,bottom=0.75in"
    link-citations:   yes
    colorlinks:       yes
    urlcolor:         blue
    biblio-style:     apalike
  bookdown::word_document2: default
# date:           "`r format(Sys.time(), '%F')`"
---



```{r echo=F, include=T, warning=FALSE}
## document configurations 
knitr::opts_chunk$set(comment    = ""      )
# knitr::opts_chunk$set(dev        = "pdf"   )
knitr::opts_chunk$set(out.width  = "70%"   )
knitr::opts_chunk$set(fig.align  = "center")
knitr::opts_chunk$set(fig.pos    = 'h!'    )
options(knitr.graphics.auto_pdf = FALSE)
library(pander)
library(data.table)
## load data
load("./data/common_data_14_2.Rda")
TSIinfo <- data.table(read.csv("./figures/tbl_tsi_info.dat",
                    strip.white = TRUE,
                    sep = ";",
                    header = TRUE))
## variables we use
source("~/MANUSCRIPTS/2022_sdr_trends/DHI_GHI_0_variables.R")

## create local citations file
source("~/CODE/FUNCTIONS/R/gather_citations.R")

suppressMessages(
    gather_citations(
        sourcefile   = "./Article.Rmd",
        mainreposit  = "./Mainreferences.bib",
        localreposit = "./references.bib",
        folderlink   = "./References_links",
        workingdir   = "~/MANUSCRIPTS/2022_sdr_trends/"
    )
)
```




<!-- SDR or GHI ? -->

Cloud “shrinking” and “optical thinning” in the “dimming” period and a subsequent recovery in the “brightening” period over China

aerosols not only strengthen but also weaken the
growth of clouds with respect to their coverage and
optical thickness, depending on the levels of pollution
and the associated amounts of aerosols as postulated
in a conceptual framework (Wild 2009a, 2012, Yang
et al 2012). 




# Introduction.

The shortwave downward solar irradiance (SDR) at the Earth's surface plays a significant role, on Earths climate.
Changes of the SDR can be related to major changes on the Earth's energy budget, the mechanisms of climate change, and water and carbon cycle [@Wild2009].
Studies of SDR variability, have identified some distinct SDR trends on different regions of the world and for different time periods, using the term 'brightening' for positive trends, and 'dimming' for negative trends.
There are many cases on the long term records, showing a change of SDR trends direction, occurring roughly at the last decades of the 20th century.
<!-- Trends -->
@Yang2021 reports a general dimming before 2000 and a brightening afterwards on multiple station in China. 
@Wild2021 shows a similar pattern, with the breaking point around 1980 from a 71 years record of a Central Europe station and for Brazil by @Yamasoe2021.
<!-- @Yamasoe2021 similar dimming and brightening around 1980 in Brazil -->
Another approach, using AI aided spatial analysis on continent level, of numerous observational stations data, reach similar conclusions for the above regions and the global trend [@Yuan2021].



There is a consensus, among researchers, that the major factors of the attenuation of SDR is the interaction with the atmospheric aerosols and the clouds. 

Due to the variability of those factors and the interaction between them,

...... cloud formation occurrences and constitution nuclei. cite.....

it is difficult to estimate the SDR trends on each site.

Multiple studies attempt to evaluate the phenomenon and the potential causes [@Ohvril2009; @Schwarz2020; @Wild2009; @Wild2012; @Xia2007; @Zerefos2009; and references therein].
<!-- causes say less we don't do that -->


There is a also a need to evalutate the trends on different location


In this study, we examine the trends of SDR with ground-based measurements at Thessaloniki for the period 1993 - 2023, as derived from a CM-21 pyranometer.
<!-- goals -->
We reevaluate and extend the dataset used by @Bais2013, applying a different algorithm for the identification of clear-/cloud-sky instances, and we derive the radiation trends for this period under different sky conditions (all-sky, clear-sky and cloud-sky).

...

Site location description and aerosols effect 

...

<!-- basic concepts -->
Our method to characterize the sky conditions and the definition of each sky condition has some subjectivity.
The algorithm was calibrated with the main focus to identify the presence of clouds on the sky dome, although there are marginal cases that there will be false positives or false negatives identifications.


# Data and methodology.

<!-- time span -->
The SDR is equivalent to the whole sky Global radiation, also refered as Global Horizontal Irradiance (GHI), and was obtained with a horizontal leveled, CM-21 pyranometer.
SDR data spans the period of 
`r min(ALL_1_daily_DESEAS$Date)` to `r max(ALL_1_daily_DESEAS$Date)`.
In some algorithms we used as auxiliary data, the direct beam radiation (DNI) for comparisons, obtained by a CHP-1 pyrheliometer, with data availability from 
`r min(ALL_1_daily_DESEAS[!is.na(DIR_att), Date])` to `r max(ALL_1_daily_DESEAS[!is.na(DIR_att), Date])`.

...

...


<!-- ## Preparation. -->

There are three distinct steps to the creation of this dataset:
a) the acquisition of radiation measurements from the sensors, 
b) a radiation data quality check, and 
c) the identification of "clear sky" conditions from the radiometric data
d) data aggregation and trend analysis.

<!-- ### Acquisition of radiometric data. -->

<!-- measurement -->
For the acquisition of radiometric data,
the signal of the broadband instruments is sampled with a rate of $1 \text{Hz}$. The mean and standard deviation values are recorded for every minute.
<!-- dark correction -->
The measurements are corrected for the zero offset of the instrument signal.
As reference of the "dark signal" is used the Sun elevation angle bellow $-10^\circ$, for a period of $3 \text{h}$.
<!-- physical quantities -->
The signal is converted to radiation flux, using a ramped value of the instrument sensitivity, derived from the eight laboratory calibrations of the instrument, during the study period.

<!-- ### Radiation data quality check -->
<!-- The radiation quality is assured with a manual screening, aided by an automatic assessment process. -->
<!-- screening -->
A manual screening is performed, to remove inconsistencies and erroneous recordings, that can occur randomly or systematically, during the long continuous operation of the instrument.
<!-- Quality assurance -->
The manual screening is aided by a radiation data quality assurance procedure, adjusted for this site, based on methods of Long and Shi\ [@Long2008a ; @Long2006].
Thus, problematic recordings have been excluded from further processing. 
Although it is not possible to detect all the bad data, the large number of data and the aggregation scheme we use, can provide us with accurate radiometric measurements, for the scope of this study.


## Clear sky identification 

......

<!-- CS_id v14.2 inserted here -->
```{r setup, echo=F, include=T, eval=TRUE}
## Load Clear Sky id variables
MS <- data.frame(readRDS("~/CS_id/PARAMS/Clear_sky_id_Reno-Hansen_apply_v14_2.Rds"))
# export all variables
for (an in names(MS)) {
    assign(an, MS[[an]])
}
```


<!-- # Detection of clear periods in GHI measurements for SDR trends. -->

As global radiation clear sky reference we are using the Haurwitz’s model, adjusted for our site with a factor of `r signif(alpha,3)` (Eq. \ref{eq:ahau}).
The selection of a clear sky reference model, was based on SDR observation from the period 2016 – 2021.
Where, after an iterative optimization of eight simple models (Daneshyar–Paltridge–Proctor, Kasten–Czeplak, Haurwitz, Berger–Duffie, Adnot–Bourges–Campana–Gicquel, Robledo-Soler, Kasten and Ineichen-Perez) with different factors.
We found, that Haurwitz’s model, adjusted with a factor of `r signif(alpha,3)` has the lower root mean squared error (RMSE). 
The tried models are described by @Reno2012 and tested by @Reno2016.
The iterative optimization method, for the selection of the reference is discussed by @Long2000 and @Reno2016.

\begin{equation}
\text{SDR}_\text{Clear Sky} = `r signif(alpha,3)` \times 1098 \times \cos( \text{SZA} ) \times \exp \left( \frac{ - 0.057}{\cos(\text{SZA})} \right) \label{eq:ahau}
\end{equation}




The following criteria and thresholds were used to identify clear-sky conditions.
Each criterion was applied for a running window of $`r nt`$ consecutive measurements/minutes, and the characterization is applied at the center value of the window.
A data point is consider as under cloud-sky condition if it fails to pass any of the criteria, all the other data points are characterized as clear-sky.


<!-- 1. MeanVIP -->
### Mean value of irradiance during the time period.

The mean of the measured value $\overline{G}_i$ must be inside an envelope based on the reference model $\text{SDR}_\text{Clear Sky}$ (Eq. \ref{eq:MeanVIP}).

\begin{equation}
`r 1 - CS_ref_rm_VIP_RelLow` \times \overline{\text{SDR}}_{i\text{Clear Sky}} - `r CS_ref_rm_VIP_LowOff`
< \overline{G}_i <
`r 1 + CS_ref_rm_VIP_RelUpp` \times \overline{\text{SDR}}_{i\text{Clear Sky}} + `r CS_ref_rm_VIP_UppOff`
\label{eq:MeanVIP}
\end{equation}


<!-- 2. MaxVIP -->
### Max value of irradiance during the time period.

The running max measured value $M_{Gi} = max[\text{SDR}_{i}]$, is compared to a similar constructed value from the reference $M_{CSi} = max[\text{SDR}_{i\text{Clear Sky}}]$ (Eq. \ref{eq:MaxVIP}).

\begin{equation}
`r MaxVIP_fct` \times M_{CSi} - `r MaxVIP_off_low`
< M_{Gi} <
`r MaxVIP_fct` \times M_{CSi} + `r MaxVIP_off_upp`
\label{eq:MaxVIP}
\end{equation}


<!-- 3. VIL -->
### Variability in irradiance by line length.

The length $L$ (Eq. \ref{eq:VILeq}) of the sequence of line segments connecting the points of the SDR time
series for the measured values $L$ and similar for the reference $L_{CS}$, must be within the limits of Eq. \ref{eq:VILcr}.

\begin{equation}
L = \sum_{i=1}^{n-1}\sqrt{\left ( \text{SDR}_{i+1} - \text{SDR}_{i}\right )^2 + \left ( t_{i+1} - t_i \right )^2}
\label{eq:VILeq}
\end{equation}

\begin{equation}
`r MinVIL_fct` \times L_{CSi} - `r offVIL_dwl` < L_i < `r MaxVIL_fct` \times L_{CSi} + `r offVIL_upl`
\label{eq:VILcr}
\end{equation}


<!-- 4. VCT -->
### Variance of Changes in the Time series.

<!-- Standard deviation of rate of change in irradiance. -->
We calculate the standard deviation $\sigma$ of the slope
($s$) between sequential points in the time series, normalized by the average SDR during the time interval.

\begin{gather}
s_i = \frac{\text{SDR}_{i+1} - \text{SDR}_{i}}{t_{i+1} - t_i}, \forall i \in \left \{ 1, 2, \ldots, n-1 \right \} \label{eq:VCT1} \\
\bar{s} = \frac{1}{n-1} \sum_{i=1}^{n-1} s_i \label{eq:VCT2} \\
\sigma_i = \frac {\sqrt{\frac{1}{n-1} \sum_{i=1}^{n-1} \left( s_i - \bar{s} \right)^2} } {\bar{G_i}} \label{eq:VCT3}
\end{gather}

\begin{equation}
\sigma_i < `r offVCT`
\label{eq:VCTcr}
\end{equation}


<!-- 5. VSM -->
### Variability in the Shape of the irradiance Measurements.

The maximum difference $X$ between the change in measured irradiance and the change in clear sky
irradiance over each measurement interval.

\begin{gather}
x_i = \text{SDR}_{i+1} - \text{SDR}_{i} \forall i \in \left \{ 1, 2, \ldots, n-1 \right \} \label{eq:VSM1} \\
x_{CS,i} = \text{SDR}_{CS,i+1} - \text{SDR}_{CS,i} \forall i \in \left \{ 1, 2, \ldots, n-1 \right \} \label{eq:VSM2} \\
X_i = \max{\left \{ \left | x_i - x_{CS,i} \right | \right \}} \label{eq:VSM3}
\end{gather}

\begin{equation}
X_i < `r offVSM`
\label{eq:VSMcr}
\end{equation}










....

<!-- ### Clear sky ID -->
In order to estimate the effect of the clouds on the SDR we created three datasets, by characterizing each one-minute measurement with a corresponding sky condition. 
The all-sky conditions, containing all the valid measurements. 
The clear-sky conditions data, where we have inferred that the sky was almost clear of clouds, and the remainder part the data as cloudy sky conditions data (cloud-sky). 
To identify the clear-sky conditions we used the method proposed by @Long2000 and by @Reno2016, that was adapted and configured for the site.
<!-- CS subjectivity -->
We have to note, that the definition of what constitutes as clear or cloudy sky, has some subjectivity, due to the used method of characterization.
As a result, the details of the definition are site specific, it relies on a combination of threshold of comparisons with ideal actinometric models and statistics on different signal behavior.


## Data and data selection.

<!-- ### Data selection -->
Due to a significant measurement uncertainty near, the horizon, we have to exclude
all measurements with SZA greater than $`r 90-MIN_ELEVA`^\circ$. 
Moreover, due to some obstructions around the site (hills and buildings), we excluded data with Azimuth angle between 
$35^\circ$ and $120^\circ$ with SZA greater than $80^\circ$.
On the latter instances, Sun is systematically, not visible by the instrument's location.
<!-- 1au -->
To make the measurements comparable throughout the dataset, we adjusted all 1-minute radiometric values to the mean Sun - Earth distance.
<!-- TSI -->
Subsequently, we made all measurements relative to the Total Solar Irradiance (TSI) at $1 \text{au}$, in order to compensate for the Sun's intensity variability, using a homogenized time series of satellite TSI observations.
The TSI data we use, is a combination of data from NOAA [@Coddington2005] (for `r as.Date(TSIinfo[TSI_Source == "NOAA", Start])` - `r as.Date(TSIinfo[TSI_Source == "NOAA", End])`) and adjusted data from @LASP2023 (for `r as.Date(TSIinfo[TSI_Source != "NOAA", Start])` - `r as.Date(TSIinfo[TSI_Source != "NOAA", End])`).
As a result, we can present all radiation data as a fraction of Sun's TSI.

### Aggregation of radiometric data

<!-- aggregation -->
Before further analysis and deseasonalization, we implement an appropriate aggregation scheme on the 1-minute data. To preserve the representativeness we use the following criteria:
a) for daily mean values we exclude instances with less than `r Daily_aggregation_N_lim` valid data points,
b) accordingly, monthly values are computed by daily aggregated data, where months with less than `r Monthly_aggegation_N_lim` days are rejected. 
The daily seasonal values were indexed based on the day of year number, and the monthly by the corresponding calendar month.
<!-- Seasonal -->
For the seasons of the year trends, we grouped the mean daily values by season (December - February: Winter, March - May: Spring, etc.).
<!-- Deseasonalization -->
Finally, for each data set, we remove the natural occurring seasonal variation.
This is done, by calculating the mean values for the appropriate time step, and subtracting the annual cycle from the actual data.
<!-- SZA Deseasonalization -->
In addition to the previous aggregation scheme, each dataset was aggregate in $1^\circ$ SZA bins, separate for cases before and after local noon. 
This gave us an approximation of Sun's SZA contribution to the SDR brightening. 

Thus, for each data set we have obtained the relative departure of the seasonal mean.
The statistical significance and aggregation scheme and filtering will be noted along with the corresponding results.


# Results

<!-- \FloatBarrier -->

## Long-term trends

Using the mean daily SDR we produce the trends of each data set, as departure from the seasonal value.
Only for All-sky (Fig. \ref{fig:trendALL}) <!--and Cloudy-sky (Fig. \ref{fig:trendCLOUD})--> conditions, the statistical significance of the trends are acceptable (Tab. \ref{tab:trendtable}), to draw some conclusions.

```{r trendALL, echo=F, fig.cap="Anomaly (\\%) of the daily SDR relative to climatological values for 1993 - 2023. The black line shows the long term trend for all-sky conditions."}
knitr::include_graphics("./images/LongtermTrends-2.png")
```


<!-- ```{r trendCLEAR, echo=F, fig.cap="Daily SDR seasonal anomaly and long term trend, for clear sky conditions."} -->
<!-- knitr::include_graphics("./images/LongtermTrends-4.png") -->
<!-- ``` -->

<!-- ```{r trendCLOUD, echo=F, fig.cap="Anomaly (\\%) of the daily SDR relative to climatological values for 1993 - 2023. The black line shows the long term trend for cloud-sky conditions."} -->
<!-- knitr::include_graphics("./images/LongtermTrends-6.png") -->
<!-- ``` -->

<!-- \footnotesize -->
```{r trendtable, echo=F}
LT <- data.table(read.csv("./figures/tbl_longterm_trends.dat",
               strip.white = TRUE,
               sep = ";",
               header = TRUE))
LT <- LT[grep("SDR", LT$var), ]
LT$slope.sd           <- NULL
LT$slope.ConfInt_0.95 <- NULL
LT$slope.ConfInt_0.99 <- NULL
LT$var                <- NULL
setorder(LT, -slope.stat_sig)
rownames(LT) <- NULL
names(LT) <- c("Trend [%/year]", "Trend p-value", "Sky condition", "Trend statistical signif. [%]")

panderOptions("table.alignment.default", "center")
pander(LT,
       caption = "\\label{tab:trendtable}Trends of daily means by sky conditions.")
# \\label{tab:tab2}
# knitr::kable(LT, caption = "Trends of daily means by sky conditions.")

## some vars to use
alltrend   <- signif(LT[`Sky condition` == "All sky cond.",   `Trend [%/year]`], 2)
cleartrend <- signif(LT[`Sky condition` == "Clear sky cond.", `Trend [%/year]`], 2)
cloudtrend <- signif(LT[`Sky condition` == "Cloudy cond.",    `Trend [%/year]`], 2)
```
<!-- \normalsize -->


<!-- \FloatBarrier -->

## Long term trends by Solar zenith angle.

Analyzing the long term trends of SDR to bins of SZA, we can see the contribution of the geometry and time in a diurnal level (Figures \ref{fig:szatrends}a and \ref{fig:szatrends}b). Although there is a seasonal distribution of SZA than in not presented here.

<!-- ```{r , echo=F, fig.cap="All sky"} -->
<!-- knitr::include_graphics("./images/SzaTrends-5.png") -->
<!-- ``` -->

<!--
```{r , echo=F, fig.cap="Clear sky"}
knitr::include_graphics("./images/SzaTrends-13.png")
```
-->

<!-- ```{r , echo=F, fig.cap="Cloud sky"}
knitr::include_graphics("./images/SzaTrends-21.png")
``` -->


```{r szatrends, echo = FALSE, fig.cap='Distribution of the SDR\'s long term trends by SZA.', fig.subcap=c('Trend distribution for all-sky conditions.', 'Trend distribution for cloud-sky conditions.'), out.width='.35\\linewidth', fig.asp=1, fig.ncol = 2}
knitr::include_graphics("./images/SzaTrends-13.png")
knitr::include_graphics("./images/SzaTrends-21.png")
```



<!-- \FloatBarrier -->

## Long term trends by season of year

Similar we have produced the deseasonalized trend for different sky conditions for each season of the year, using the corresponding mean monthly values.
This can give us a better understanding of the annual variability of the trends.

```{r seasonalALL, echo=F, fig.cap="Trends by season for all condition. Displaying monthly means of daily means.", out.width="100%"}
knitr::include_graphics("./images/SeasonalTrendsTogether-1.png")
```


<!-- ```{r seasonalALL, echo=F, fig.cap="Trends by season for All-sky condition. Displays monthly means of daily means."} -->
<!-- knitr::include_graphics("./images/SeasonalTrends-1.png") -->
<!-- ``` -->

<!-- ```{r seasonalCLEAR, echo=F, fig.cap="Trends by season for Clear-sky condition. Displays monthly means of daily means."} -->
<!-- knitr::include_graphics("./images/SeasonalTrends-2.png") -->
<!-- ``` -->

<!-- ```{r seasonalCLOUD, echo=F, fig.cap="Trends by season for Cloudy-sky condition. Displays monthly means of daily means."} -->
<!-- knitr::include_graphics("./images/SeasonalTrends-3.png") -->
<!-- ``` -->




<!-- \footnotesize -->
```{r trendseasontable, echo=F}
pp <- read.csv("./figures/tbl_longterm_trends_season.dat",
               strip.white = TRUE,
               sep = ";",
               header = TRUE)
pp <- pp[grep("SDR" ,pp$var), ]
pp$slope.sd           <- NULL
pp$slope.ConfInt_0.95 <- NULL
pp$slope.ConfInt_0.99 <- NULL
pp$var                <- NULL
rownames(pp) <- NULL
names(pp) <- c("Trend [%/year]", "Trend p-value", "Sky condition", "Season", "Trend statistical signif. [%]")

# panderOptions("table.alignment.default", "left")
panderOptions("table.alignment.default", "center")
pander(pp,
       caption = "\\label{tab:trendseasontable}Trends of daily means by sky conditions for the seasons of the year.")
```
<!-- \normalsize -->



<!-- \FloatBarrier -->
<!-- 
## Zenith angle dependency and seasons of the year.
-->

<!-- \FloatBarrier -->

## Consistency of the trends

A method to evaluate changes in the long term trend is to use the cumulative sum of the variable.

Figure \ref{fig:cumsum}

... different in aggregation ...

<!--
```{r cumsumALL, echo=F, fig.cap="Running cumulative sum."}
knitr::include_graphics("./images/CumulativeDailyCumSum-1.png")
```
-->

<!--
Not showing this trend
```{r cumsumCLEAR, echo=F, fig.cap="Donditions.", include=FALSE}
knitr::include_graphics("./images/CumulativeDailyCumSum-5.png")
```
-->

<!--
```{r cumsumCLOUD, echo=F, fig.cap="Donditions."}
knitr::include_graphics("./images/CumulativeDailyCumSum-9.png")
```
-->

```{r cumsum, echo = FALSE, fig.cap='two plots', fig.subcap=c('one plot', 'the other one'), out.width='.35\\linewidth', fig.asp=1, fig.ncol = 2}
knitr::include_graphics(c("./images/CumulativeDailyCumSum-1.png", "./images/CumulativeDailyCumSum-9.png"))
```


# Conclusions

Our result for all-sky condition ($`r alltrend`\%/year$), reaffirm the previous results of @Bais2013 for the site.
The increase of this trend, shows that the phenomenon and probably the causes have been amplified.

.....
Also, the trend of $`r cloudtrend`\%/year$ for cloud-sky condition indicate the major part that clouds play on the
.....

.......

 
About:

- long terms trends
- seasonal trends
- effect of SZA
- effect of clouds

- Aerosols


similar results with Evidence for Clear‐Sky Dimming and Brightening in Central Europe_Wild2021.pdf
inclue in discusion


-------------------------------------------------
                   **END**
-------------------------------------------------
