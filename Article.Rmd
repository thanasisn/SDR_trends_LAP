---
title:         "Trends of SDR in Thessaloniki"
# header-includes:
author:
  - name:         Natsis Athanasios
    email:        natsisphysicist@gmail.com
    affiliation:  Laboratory of Atmospheric Physics
#    footnote:     1
    correspondingauthor: true
  - name:         Alkiviadis Bais
    email:        abais@auth.gr 
    affiliation:  Laboratory of Atmospheric Physics
    correspondingauthor: false
address:
  - code:         Laboratory of Atmospheric Physics
    organization: Aristotle University of Thessaloniki
    addressline:  Campus Box 149
    city:         Thessaloniki
    # state:        State
    postcode:     54124
    country:      Greece
#  - code:         Another University
#    organization: Department
#    addressline:  A street 29
#    postcode:     2054 NX
#    city:         Manchester,
#    country:      The Netherlands
# footnote:
#   - code:         1
#     text:         "This is the first author footnote."
#   - code:         2
#     text:         "Another author footnote."
abstract: |
  Study of GHI and DNI radiation for 'clear-sky' and all-sky conditions.
  It consists of two paragraphs.
keywords: 
  - GHI
  - SDR
  - Solar Brigthening/Dimming
journal:        "An awesome journal"
date:           "`r Sys.Date()`"
classoption:    preprint, 3p, authoryear
bibliography:   references.bib
linenumbers:          false
numbersections:       true
header-includes:
   # - \usepackage{subfig}
   - \usepackage{subcaption}
output: 
  rticles::elsevier_article:
    keep_tex:         true
    citation_package: natbib
  bookdown::pdf_document2:
    number_sections:  no
    fig_caption:      yes
    keep_tex:         yes
    latex_engine:     xelatex
    toc:              yes
    toc_depth:        4
    fig_width:        7
    fig_height:       4.5
    documentclass:    article
    classoption:      a4paper,oneside
    fontsize:         12pt
    geometry:         "left=0.75in,right=0.75in,top=0.75in,bottom=0.75in"
    link-citations:   yes
    colorlinks:       yes
    urlcolor:         blue
    biblio-style:     apalike
# date:           "`r format(Sys.time(), '%F')`"
---



```{r echo=F, include=T}
## document configurations 
knitr::opts_chunk$set(comment    = ""      )
knitr::opts_chunk$set(dev        = "pdf"   )
knitr::opts_chunk$set(out.width  = "70%"   )
knitr::opts_chunk$set(fig.align  = "center")
knitr::opts_chunk$set(fig.pos    = 'h!'    )
library(pander)
library(data.table)
## load data
load("./data/common_data_14_2.Rda")
TSIinfo <- data.table(read.csv("./figures/tbl_tsi_info.dat",
                    strip.white = TRUE,
                    sep = ";",
                    header = TRUE))
## variables we use
source("~/MANUSCRIPTS/2022_sdr_trends/DHI_GHI_0_variables.R")
```

<!-- SDR or GHI ? -->


# Introduction.

The shortwave downward solar irradiance (SDR) at the Earth's surface plays a significant role, on Earths climate.
Changes of the SDR can be related to major changes on factors affecting the radiative forcing balance and human activities.
Multiple studies attempt to evaluate the phenomenon and the potential causes [@Ohvril2009; @Schwarz2020; @Wild2009; @Wild2012; @Xia2007; @Zerefos2009].
Although, there is regional variation of SDR, with both positive and negative trends, most of the studies agree that the major factors are the interaction of aerosols and clouds.

In this study, we examine the trends of SDR with ground-based measurements at Thessaloniki for the period 1993 - 2023, as derived from a CM-21 pyranometer.
<!-- goals -->
We reevaluate and extend the dataset used by @Bais2013, applying a different algorithm for the identification of clear-/cloud-sky instances, and we derive the radiation trends for this period under different sky conditions (all-sky, clear-sky and cloud-sky).

...

Site location description and aerosols effect 

...

<!-- basic concepts -->
Our method to characterize the sky conditions and the definition of each sky condition has some subjectivity.
The algorithm was calibrated with the main focus to identify the presence of clouds on the sky dome, although there are marginal cases that there will be false positives or false negatives identifications.


# Data and methodology.

<!-- time span -->
The SDR is equivalent to the whole sky Global radiation, also refered as Global Horizontal Irradiance (GHI), and was obtained with a horizontal leveled, CM-21 pyranometer.
SDR data spans the period of 
`r min(ALL_1_daily_DESEAS$Date)` to `r max(ALL_1_daily_DESEAS$Date)`.
In some algorithms we used as auxiliary data, the direct beam radiation (DNI) for comparisons, obtained by a CHP-1 pyrheliometer, with data availability from 
`r min(ALL_1_daily_DESEAS[!is.na(DIR_att), Date])` to `r max(ALL_1_daily_DESEAS[!is.na(DIR_att), Date])`.

...

...


<!-- ## Preparation. -->

There are three distinct steps to the creation of this dataset:
a) the acquisition of radiation measurements from the sensors, 
b) a radiation data quality check, and 
c) the identification of "clear sky" conditions from the radiometric data
d) data aggregation and trend analysis.

<!-- ### Acquisition of radiometric data. -->

<!-- measurement -->
For the acquisition of radiometric data,
the signal of the broadband instruments is sampled with a rate of $1 \text{Hz}$. The mean and standard deviation values are recorded for every minute.
<!-- dark correction -->
The measurements are corrected for the zero offset of the instrument signal.
As reference of the "dark signal" is used the Sun elevation angle bellow $-10^\circ$, for a period of $3 \text{h}$.
<!-- physical quantities -->
The signal is converted to radiation flux, using a ramped value of the instrument sensitivity, derived from the eight laboratory calibrations of the instrument, during the study period.

<!-- ### Radiation data quality check -->
<!-- The radiation quality is assured with a manual screening, aided by an automatic assessment process. -->
<!-- screening -->
A manual screening is performed, to remove inconsistencies and erroneous recordings, that can occur randomly or systematically, during the long continuous operation of the instrument.
<!-- Quality assurance -->
The manual screening is aided by a radiation data quality assurance procedure, adjusted for this site, based on methods of Long and Shi\ [-@long_automated_2008; -@Long2006].
Thus, problematic recordings have been excluded from further processing. 
Although it is not possible to detect all the bad data, the large number of data and the aggregation scheme we use, can provide us with accurate radiometric measurements, for the scope of this study.


## Clear sky identification 

......

expanded description

....

<!-- ### Clear sky ID -->
In order to estimate the effect of the clouds on the SDR we created three datasets, by characterizing each one-minute measurement with a corresponding sky condition. 
The all-sky conditions, containing all the valid measurements. 
The clear-sky conditions data, where we have inferred that the sky was almost clear of clouds, and the remainder part the data as cloudy sky conditions data (cloud-sky). 
To identify the clear-sky conditions we used the method proposed by @Long2000 and by @Reno2016, that was adapted and configured for the site.
<!-- CS subjectivity -->
We have to note, that the definition of what constitutes as clear or cloudy sky, has some subjectivity, due to the used method of characterization.
As a result, the details of the definition are site specific, it relies on a combination of threshold of comparisons with ideal actinometric models and statistics on different signal behavior.


## Data and data selection.

<!-- ### Data selection -->
Due to a significant measurement uncertainty near, the horizon, we have to exclude
all measurements with SZA greater than $`r 90-MIN_ELEVA`^\circ$. 
Moreover, due to some obstructions around the site (hills and buildings), we excluded data with Azimuth angle between 
$35^\circ$ and $120^\circ$ with SZA greater than $80^\circ$.
On the latter instances, Sun is systematically, not visible by the instrument's location.
<!-- 1au -->
To make the measurements comparable throughout the dataset, we adjusted all 1-minute radiometric values to the mean Sun - Earth distance.
<!-- TSI -->
Subsequently, we made all measurements relative to the Total Solar Irradiance (TSI) at $1 \text{au}$, in order to compensate for the Sun's intensity variability, using a homogenized time series of satellite TSI observations.
The TSI data we use, is a combination of data from NOAA [@Coddington2005] (for `r as.Date(TSIinfo[TSI_Source == "NOAA", Start])` - `r as.Date(TSIinfo[TSI_Source == "NOAA", End])`) and adjusted data from @TSIStsi (for `r as.Date(TSIinfo[TSI_Source != "NOAA", Start])` - `r as.Date(TSIinfo[TSI_Source != "NOAA", End])`).
As a result, we can present all radiation data as a fraction of Sun's TSI.

### Aggregation of radiometric data

<!-- aggregation -->
Before further analysis and deseasonalization, we implement an appropriate aggregation scheme on the 1-minute data. To preserve the representativeness we use the following criteria:
a) for daily mean values we exclude instances with less than `r Daily_aggregation_N_lim` valid data points,
b) accordingly, monthly values are computed by daily aggregated data, where months with less than `r Monthly_aggegation_N_lim` days are rejected. 
The daily seasonal values were indexed based on the day of year number, and the monthly by the corresponding calendar month.
<!-- Seasonal -->
For the seasons of the year trends, we grouped the mean daily values by season (December - February: Winter, March - May: Spring, etc.).
<!-- Deseasonalization -->
Finally, for each data set, we remove the natural occurring seasonal variation.
This is done, by calculating the mean values for the appropriate time step, and subtracting the annual cycle from the actual data.
<!-- SZA Deseasonalization -->
In addition to the previous aggregation scheme, each dataset was aggregate in $1^\circ$ SZA bins, separate for cases before and after local noon. 
This gave us an approximation of Sun's SZA contribution to the SDR brightening. 

Thus, for each data set we have obtained the relative departure of the seasonal mean.
The statistical significance and aggregation scheme and filtering will be noted along with the corresponding results.


# Results

<!-- \FloatBarrier -->

## Long-term trends

Using the mean daily SDR we produce the trends of each data set, as departure from the seasonal value.
Only for All-sky (Fig. \ref{fig:trendALL}) <!--and Cloudy-sky (Fig. \ref{fig:trendCLOUD})--> conditions, the statistical significance of the trends are acceptable (Tab. \ref{tab:trendtable}), to draw some conclusions.

```{r trendALL, echo=F, fig.cap="Anomaly (\\%) of the daily SDR relative to climatological values for 1993 - 2023. The black line shows the long term trend for all-sky conditions."}
knitr::include_graphics("./images/LongtermTrends-2.pdf")
```

<!-- ```{r trendCLEAR, echo=F, fig.cap="Daily SDR seasonal anomaly and long term trend, for clear sky conditions."} -->
<!-- knitr::include_graphics("./images/LongtermTrends-4.pdf") -->
<!-- ``` -->

<!-- ```{r trendCLOUD, echo=F, fig.cap="Anomaly (\\%) of the daily SDR relative to climatological values for 1993 - 2023. The black line shows the long term trend for cloud-sky conditions."} -->
<!-- knitr::include_graphics("./images/LongtermTrends-6.pdf") -->
<!-- ``` -->

<!-- \footnotesize -->
```{r trendtable, echo=F}
LT <- data.table(read.csv("./figures/tbl_longterm_trends.dat",
               strip.white = TRUE,
               sep = ";",
               header = TRUE))
LT <- LT[grep("SDR", LT$var), ]
LT$slope.sd           <- NULL
LT$slope.ConfInt_0.95 <- NULL
LT$slope.ConfInt_0.99 <- NULL
LT$var                <- NULL
setorder(LT, -slope.stat_sig)
rownames(LT) <- NULL
names(LT) <- c("Trend [%/year]", "Trend p-value", "Sky condition", "Trend statistical signif. [%]")

panderOptions("table.alignment.default", "center")
pander(LT,
       caption = "\\label{tab:trendtable}Trends of daily means by sky conditions.")
# \\label{tab:tab2}
# knitr::kable(LT, caption = "Trends of daily means by sky conditions.")

## some vars to use
alltrend   <- signif(LT[`Sky condition` == "All sky cond.",   `Trend [%/year]`], 2)
cleartrend <- signif(LT[`Sky condition` == "Clear sky cond.", `Trend [%/year]`], 2)
cloudtrend <- signif(LT[`Sky condition` == "Cloudy cond.",    `Trend [%/year]`], 2)
```
<!-- \normalsize -->


<!-- \FloatBarrier -->

## Long term trends by Solar zenith angle.

Analyzing the long term trends of SDR to bins of SZA, we can see the contribution of the geometry and time in a diurnal level (Figures \ref{fig:szatrends}a and \ref{fig:szatrends}b). Although there is a seasonal distribution of SZA than in not presented here.

<!-- ```{r , echo=F, fig.cap="All sky"} -->
<!-- knitr::include_graphics("./images/SzaTrends-5.pdf") -->
<!-- ``` -->

<!--
```{r , echo=F, fig.cap="Clear sky"}
knitr::include_graphics("./images/SzaTrends-13.pdf")
```
-->

<!-- ```{r , echo=F, fig.cap="Cloud sky"}
knitr::include_graphics("./images/SzaTrends-21.pdf")
``` -->


```{r szatrends, echo = FALSE, fig.cap='Distribution of the SDR\'s long term trends by SZA.', fig.subcap=c('Trend distribution for all-sky conditions.', 'Trend distribution for cloud-sky conditions.'), out.width='.35\\linewidth', fig.asp=1, fig.ncol = 2}
knitr::include_graphics("./images/SzaTrends-13.pdf")
knitr::include_graphics("./images/SzaTrends-21.pdf")
```



<!-- \FloatBarrier -->

## Long term trends by season of year

Similar we have produced the deseasonalized trend for different sky conditions for each season of the year, using the corresponding mean monthly values.
This can give us a better understanding of the annual variability of the trends.

```{r seasonalALL, echo=F, fig.cap="Trends by season for all condition. Displaying monthly means of daily means.", out.width="100%"}
knitr::include_graphics("./images/SeasonalTrendsTogether-1.pdf")
```


<!-- ```{r seasonalALL, echo=F, fig.cap="Trends by season for All-sky condition. Displays monthly means of daily means."} -->
<!-- knitr::include_graphics("./images/SeasonalTrends-1.pdf") -->
<!-- ``` -->

<!-- ```{r seasonalCLEAR, echo=F, fig.cap="Trends by season for Clear-sky condition. Displays monthly means of daily means."} -->
<!-- knitr::include_graphics("./images/SeasonalTrends-2.pdf") -->
<!-- ``` -->

<!-- ```{r seasonalCLOUD, echo=F, fig.cap="Trends by season for Cloudy-sky condition. Displays monthly means of daily means."} -->
<!-- knitr::include_graphics("./images/SeasonalTrends-3.pdf") -->
<!-- ``` -->




<!-- \footnotesize -->
```{r trendseasontable, echo=F}
pp <- read.csv("./figures/tbl_longterm_trends_season.dat",
               strip.white = TRUE,
               sep = ";",
               header = TRUE)
pp <- pp[grep("SDR" ,pp$var), ]
pp$slope.sd           <- NULL
pp$slope.ConfInt_0.95 <- NULL
pp$slope.ConfInt_0.99 <- NULL
pp$var                <- NULL
rownames(pp) <- NULL
names(pp) <- c("Trend [%/year]", "Trend p-value", "Sky condition", "Season", "Trend statistical signif. [%]")

# panderOptions("table.alignment.default", "left")
panderOptions("table.alignment.default", "center")
pander(pp,
       caption = "\\label{tab:trendseasontable}Trends of daily means by sky conditions for the seasons of the year.")
```
<!-- \normalsize -->



<!-- \FloatBarrier -->
<!-- 
## Zenith angle dependency and seasons of the year.
-->

<!-- \FloatBarrier -->

## Consistency of the trends

A method to evaluate changes in the long term trend is to use the cumulative sum of the variable.

Figure \ref{fig:cumsum}

... different in aggregation ...

<!--
```{r cumsumALL, echo=F, fig.cap="Running cumulative sum."}
knitr::include_graphics("./images/CumulativeDailyCumSum-1.pdf")
```
-->

<!--
Not showing this trend
```{r cumsumCLEAR, echo=F, fig.cap="Donditions.", include=FALSE}
knitr::include_graphics("./images/CumulativeDailyCumSum-5.pdf")
```
-->

<!--
```{r cumsumCLOUD, echo=F, fig.cap="Donditions."}
knitr::include_graphics("./images/CumulativeDailyCumSum-9.pdf")
```
-->

```{r cumsum, echo = FALSE, fig.cap='two plots', fig.subcap=c('one plot', 'the other one'), out.width='.35\\linewidth', fig.asp=1, fig.ncol = 2}
knitr::include_graphics(c("./images/CumulativeDailyCumSum-1.pdf", "./images/CumulativeDailyCumSum-9.pdf"))
```


# Conclusions

Our result for all-sky condition ($`r alltrend`\%/year$), reaffirm the previous results of @Bais2013 for the site.
The increase of this trend, shows that the phenomenon and probably the causes have been amplified.

.....
Also, the trend of $`r cloudtrend`\%/year$ for cloud-sky condition indicate the major part that clouds play on the
.....

.......

 
About:

- long terms trends
- seasonal trends
- effect of SZA
- effect of clouds

- Aerosols





-------------------------------------------------
                   **END**
-------------------------------------------------
